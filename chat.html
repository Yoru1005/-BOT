<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AIç†è²¡åŠ©ç†</title>
  <style>
    body {
      font-family: 'Segoe UI', 'Noto Sans TC', Arial, sans-serif;
      background: linear-gradient(135deg, #e0e7ff 0%, #f8fafc 100%);
      padding: 0;
      margin: 0;
      min-height: 100vh;
      transition: all 0.3s ease;
    }
    body.dark-mode {
      background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
    }
    .container {
      max-width: 540px;
      margin: 40px auto 0 auto;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 4px 24px 0 rgba(60,72,88,0.10);
      padding: 32px 24px 24px 24px;
      min-height: 80vh;
      transition: all 0.3s ease;
    }
    body.dark-mode .container {
      background: #1e293b;
      box-shadow: 0 4px 24px 0 rgba(0,0,0,0.3);
    }
    .theme-toggle {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #6366f1;
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      cursor: pointer;
      font-size: 18px;
      box-shadow: 0 2px 8px 0 #e0e7ff;
      transition: all 0.3s ease;
    }
    body.dark-mode .theme-toggle {
      background: #f59e0b;
    }
    h1 {
      text-align: center;
      color: #3b3b4f;
      margin-bottom: 24px;
      letter-spacing: 2px;
      transition: color 0.3s ease;
    }
    body.dark-mode h1 {
      color: #f1f5f9;
    }
    #chat {
      white-space: pre-wrap;
      border: 1px solid #e5e7eb;
      background: #f4f7fb;
      padding: 16px;
      max-height: 320px;
      overflow-y: auto;
      margin-bottom: 16px;
      border-radius: 8px;
      font-size: 1.05em;
      box-shadow: 0 1px 2px 0 #e0e7ff;
      transition: all 0.3s ease;
    }
    body.dark-mode #chat {
      border: 1px solid #334155;
      background: #334155;
      color: #f1f5f9;
    }
    .message.user {
      color: #2563eb;
      margin-bottom: 8px;
      text-align: right;
      font-weight: 500;
      transition: color 0.3s ease;
    }
    body.dark-mode .message.user {
      color: #60a5fa;
    }
    .message.ai {
      color: #374151;
      margin-bottom: 8px;
      text-align: left;
      background: #e0e7ff;
      display: inline-block;
      padding: 8px 14px;
      border-radius: 12px 12px 12px 0;
      max-width: 90%;
      box-shadow: 0 1px 2px 0 #e0e7ff;
      transition: all 0.3s ease;
    }
    body.dark-mode .message.ai {
      background: #475569;
      color: #f1f5f9;
    }
    .week-indicator {
      background: #fef3c7;
      color: #92400e;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.8em;
      margin-left: 8px;
      transition: all 0.3s ease;
    }
    body.dark-mode .week-indicator {
      background: #451a03;
      color: #fbbf24;
    }
    .charts-container {
      display: flex;
      gap: 16px;
      margin: 16px 0;
      flex-wrap: wrap;
    }
    .chart {
      flex: 1;
      min-width: 200px;
      background: #f8fafc;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 16px;
      transition: all 0.3s ease;
    }
    body.dark-mode .chart {
      background: #334155;
      border: 1px solid #475569;
    }
    .chart h3 {
      margin: 0 0 12px 0;
      color: #374151;
      font-size: 1em;
      transition: color 0.3s ease;
    }
    body.dark-mode .chart h3 {
      color: #f1f5f9;
    }
    .bar-chart {
      height: 120px;
      display: flex;
      align-items: end;
      gap: 4px;
      padding: 8px 0;
    }
    .bar {
      flex: 1;
      background: linear-gradient(to top, #6366f1, #8b5cf6);
      border-radius: 2px 2px 0 0;
      min-height: 4px;
      transition: all 0.3s ease;
    }
    .pie-chart {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      margin: 0 auto;
      background: conic-gradient(
        #6366f1 0deg 90deg,
        #8b5cf6 90deg 180deg,
        #ec4899 180deg 270deg,
        #f59e0b 270deg 360deg
      );
      position: relative;
    }
    .pie-chart::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 60px;
      height: 60px;
      background: #f8fafc;
      border-radius: 50%;
      transition: background 0.3s ease;
    }
    body.dark-mode .pie-chart::before {
      background: #334155;
    }

    #prompt {
      width: 70%;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #cbd5e1;
      font-size: 1em;
      margin-right: 8px;
      background: #f8fafc;
      transition: all 0.3s ease;
    }
    body.dark-mode #prompt {
      background: #475569;
      border: 1px solid #64748b;
      color: #f1f5f9;
    }
    #prompt:focus {
      border: 1.5px solid #6366f1;
      outline: none;
      background: #fff;
    }
    body.dark-mode #prompt:focus {
      background: #334155;
    }
    #sendBtn {
      padding: 10px 22px;
      border-radius: 6px;
      border: none;
      background: linear-gradient(90deg, #6366f1 0%, #2563eb 100%);
      color: #fff;
      font-weight: 600;
      font-size: 1em;
      cursor: pointer;
      transition: background 0.2s;
      box-shadow: 0 2px 8px 0 #e0e7ff;
    }
    #sendBtn:disabled {
      background: #a5b4fc;
      cursor: not-allowed;
    }
    hr {
      margin: 32px 0 18px 0;
      border: none;
      border-top: 1.5px solid #e5e7eb;
      transition: border-color 0.3s ease;
    }
    body.dark-mode hr {
      border-top-color: #475569;
    }
    h2 {
      color: #6366f1;
      margin-bottom: 12px;
      font-size: 1.18em;
      letter-spacing: 1px;
      transition: color 0.3s ease;
    }
    body.dark-mode h2 {
      color: #a78bfa;
    }
    .exp-form {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }
    .exp-form input[type="date"],
    .exp-form input[type="text"],
    .exp-form input[type="number"] {
      padding: 7px 8px;
      border-radius: 5px;
      border: 1px solid #cbd5e1;
      font-size: 1em;
      background: #f8fafc;
      transition: all 0.3s ease;
    }
    body.dark-mode .exp-form input[type="date"],
    body.dark-mode .exp-form input[type="text"],
    body.dark-mode .exp-form input[type="number"] {
      background: #475569;
      border: 1px solid #64748b;
      color: #f1f5f9;
    }
    .exp-form input:focus {
      border: 1.5px solid #6366f1;
      outline: none;
      background: #fff;
    }
    body.dark-mode .exp-form input:focus {
      background: #334155;
    }
    #addExpBtn {
      padding: 7px 18px;
      border-radius: 5px;
      border: none;
      background: linear-gradient(90deg, #22d3ee 0%, #6366f1 100%);
      color: #fff;
      font-weight: 600;
      font-size: 1em;
      cursor: pointer;
      transition: background 0.2s;
      box-shadow: 0 1px 4px 0 #e0e7ff;
    }
    #addExpBtn:active {
      background: #2563eb;
    }
    #expList {
      background: #f8fafc;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 12px 10px;
      min-height: 40px;
      margin-bottom: 10px;
      font-size: 1em;
      box-shadow: 0 1px 2px 0 #e0e7ff;
      transition: all 0.3s ease;
    }
    body.dark-mode #expList {
      background: #334155;
      border: 1px solid #475569;
      color: #f1f5f9;
    }
    #expList li {
      margin-bottom: 6px;
      color: #374151;
      letter-spacing: 0.5px;
      transition: color 0.3s ease;
    }
    body.dark-mode #expList li {
      color: #f1f5f9;
    }
    .exp-btns button {
      margin-right: 8px;
      padding: 6px 12px;
      border-radius: 4px;
      border: none;
      font-size: 0.98em;
      cursor: pointer;
            transition: background 0.2s;
    }
    #exportAdviceBtn {
      background: #ffffff;
      color: #000000;
      border: 1px solid #d1d5db;
      box-shadow: 0 1px 4px 0 #e0e7ff;
    }
    #importAdviceBtn {
      background: #ffffff;
      color: #000000;
      border: 1px solid #d1d5db;
      box-shadow: 0 1px 4px 0 #e0e7ff;
    }
    #exportAdviceBtn:hover, #importAdviceBtn:hover {
      background: #f9fafb;
      border-color: #9ca3af;
    }
    @media (max-width: 600px) {
      .container { padding: 10px 2vw; }
      #prompt { width: 100%; margin-bottom: 8px; }
      #sendBtn { width: 100%; }
      .exp-form { flex-direction: column; gap: 6px; }
      .charts-container { flex-direction: column; }
    }
  </style>
</head>
<body>
  <button class="theme-toggle" onclick="toggleTheme()">ğŸŒ™</button>
  <div class="container">
    <h1>AIç†è²¡åŠ©ç†</h1>
    <div id="chat"></div>
    <div style="display:flex; gap:8px; margin-bottom:8px; flex-wrap:wrap;">
      <input id="prompt" type="text" placeholder="è¼¸å…¥è¨Šæ¯..." />
      <button id="sendBtn">é€å‡º</button>
    </div>
    <div class="charts-container" id="chartsContainer" style="display:none;">
      <div class="chart">
        <h3>æ”¯å‡ºé¡å‹åˆ†å¸ƒ</h3>
        <div class="pie-chart"></div>
        <div style="display:flex; justify-content:space-between; margin-top:10px; font-size:0.95em;">
          <span style="color:#6366f1;">é£Ÿ</span>
          <span style="color:#8b5cf6;">è¡£</span>
          <span style="color:#10b981;">ä½</span>
          <span style="color:#f59e0b;">è¡Œ</span>
          <span style="color:#ec4899;">å¨›æ¨‚</span>
          <span style="color:#64748b;">å…¶ä»–</span>
        </div>
      </div>
      <div class="chart" style="min-width:180px;">
        <h3>æ”¶æ”¯è¨ˆç®—å™¨</h3>
        <div style="margin-bottom:8px;">
          <label>æœ¬æœˆæ”¶å…¥ï¼š<input type="number" id="incomeInput" style="width:90px; padding:4px 6px; border-radius:4px; border:1px solid #cbd5e1;" min="0" /></label>
        </div>
        <div style="margin-bottom:6px;">ç¸½æ”¯å‡ºï¼š<span id="totalExpense" style="color:#ef4444; font-weight:600;">$0</span></div>
        <div>çµé¤˜ï¼š<span id="balance" style="color:#10b981; font-weight:600;">$0</span></div>
      </div>
    </div>
    <hr>
    <h2>è¨˜å¸³æ­·å²ç´€éŒ„</h2>
    <form class="exp-form" onsubmit="return false;">
      <input type="date" id="expDate" />
      <select id="expCategory">
        <option value="é£Ÿ">é£Ÿ</option>
        <option value="è¡£">è¡£</option>
        <option value="ä½">ä½</option>
        <option value="è¡Œ">è¡Œ</option>
        <option value="å¨›æ¨‚">å¨›æ¨‚</option>
        <option value="å…¶ä»–">å…¶ä»–</option>
      </select>
      <input type="number" id="expAmount" placeholder="é‡‘é¡" style="width:80px;" />
      <input type="text" id="expNote" placeholder="å‚™è¨»" />
      <button id="addExpBtn">æ–°å¢</button>
    </form>
        <ul id="expList"></ul>
    <div class="exp-btns">
      <button id="exportAdviceBtn">åŒ¯å‡ºå»ºè­°</button>
      <input type="file" id="importAdviceFile" accept=".json" style="display:none;" />
      <button id="importAdviceBtn">åŒ¯å…¥å»ºè­°</button>
    </div>
    </div>
  <script>
    const ws = new WebSocket(`wss://hshgpt.webduino.tw`);
    const chatDiv = document.getElementById('chat');
    const promptInput = document.getElementById('prompt');
    const sendBtn = document.getElementById('sendBtn');
    const chartsContainer = document.getElementById('chartsContainer');

    // å»ºè­°ç®¡ç†
    let adviceHistory = [];
    let currentAdvice = '';
    let currentWeek = 1;

    // ä¸»é¡Œåˆ‡æ›
    function toggleTheme() {
      document.body.classList.toggle('dark-mode');
      const themeBtn = document.querySelector('.theme-toggle');
      if (document.body.classList.contains('dark-mode')) {
        themeBtn.textContent = 'â˜€ï¸';
        localStorage.setItem('theme', 'dark');
      } else {
        themeBtn.textContent = 'ğŸŒ™';
        localStorage.setItem('theme', 'light');
      }
    }

    // è¼‰å…¥ä¸»é¡Œè¨­å®š
    if (localStorage.getItem('theme') === 'dark') {
      document.body.classList.add('dark-mode');
      document.querySelector('.theme-toggle').textContent = 'â˜€ï¸';
    }

    // è¨ˆç®—é€±æ¬¡
    function calculateWeek(dateStr) {
      const date = new Date(dateStr);
      const startOfYear = new Date(date.getFullYear(), 0, 1);
      const days = Math.floor((date - startOfYear) / (24 * 60 * 60 * 1000));
      return Math.ceil((days + startOfYear.getDay() + 1) / 7);
    }

    // æ›´æ–°åœ–è¡¨
    function updateCharts() {
      if (expenses.length === 0) {
        chartsContainer.style.display = 'none';
        return;
      }

      chartsContainer.style.display = 'flex';

      // å…­å¤§é¡å‹å›ºå®šé¡è‰²é †åº
      const categoryList = ['é£Ÿ', 'è¡£', 'ä½', 'è¡Œ', 'å¨›æ¨‚', 'å…¶ä»–'];
      const colorList = ['#6366f1', '#8b5cf6', '#10b981', '#f59e0b', '#ec4899', '#64748b'];
      const categoryTotals = { é£Ÿ:0, è¡£:0, ä½:0, è¡Œ:0, å¨›æ¨‚:0, å…¶ä»–:0 };
      expenses.forEach(exp => {
        if (categoryTotals.hasOwnProperty(exp.category)) {
          categoryTotals[exp.category] += exp.amount;
        }
      });

      // æ›´æ–°åœ“é¤…åœ–
      const pieChart = document.querySelector('.pie-chart');
      const total = Object.values(categoryTotals).reduce((a, b) => a + b, 0);
      let conicGradient = '';
      let currentAngle = 0;
      categoryList.forEach((category, index) => {
        const value = categoryTotals[category];
        const percentage = total ? (value / total) * 360 : 0;
        conicGradient += `${colorList[index]} ${currentAngle}deg ${currentAngle + percentage}deg`;
        if (index < categoryList.length - 1) conicGradient += ', ';
        currentAngle += percentage;
      });
      pieChart.style.background = `conic-gradient(${conicGradient})`;
    }

    ws.onopen = () => console.log('WebSocket å·²é€£ç·š');
    ws.onerror = err => console.error('WebSocket éŒ¯èª¤', err);
    ws.onclose = () => console.log('WebSocket å·²æ–·ç·š');

    ws.onmessage = event => {
      const data = JSON.parse(event.data);
      if (data.type === 'start') {
        // é¡¯ç¤º AI å›æ‡‰å®¹å™¨ä¸¦ç¦ç”¨è¼¸å…¥
        chatDiv.innerHTML += '<div class="message ai"></div>';
        promptInput.disabled = true;
        sendBtn.disabled = true;
      } else if (data.type === 'chunk') {
        // æ›´æ–°æœ€å¾Œä¸€å‰‡ AI å›æ‡‰ï¼Œå‰é¢åŠ ä¸Š AIç†è²¡åŠ©ç†ï¼šå‰ç¶´ï¼ˆåƒ…ç¬¬ä¸€æ¬¡ chunk æ™‚åŠ ï¼‰
        const msgs = chatDiv.querySelectorAll('.message.ai');
        if (msgs.length > 0) {
          if (msgs[msgs.length - 1].textContent === '') {
            msgs[msgs.length - 1].textContent = 'AIç†è²¡åŠ©ç†ï¼š';
          }
          // éæ¿¾æ‰ç³»çµ±è¨Šæ¯
          const filteredDelta = data.delta
            .replace(/æ­£åœ¨å‚³é€ prompt åˆ° Azure OpenAI \(.*?\)\.\.\./g, '')
            .replace(/Azure OpenAI å›æ‡‰:/g, '')
            .replace(/--- å›æ‡‰çµæŸ ---/g, '');
          if (filteredDelta.trim() !== '') {
            msgs[msgs.length - 1].textContent += filteredDelta;
            chatDiv.scrollTop = chatDiv.scrollHeight;
          }
        }
      } else if (data.type === 'end') {
        // å›æ‡‰çµæŸï¼Œæ¢å¾©è¼¸å…¥ä¸¦å„²å­˜å»ºè­°
        promptInput.disabled = false;
        sendBtn.disabled = false;
        promptInput.focus();
        
        // å„²å­˜æ–°çš„å»ºè­°
        const lastMsg = chatDiv.querySelectorAll('.message.ai');
        if (lastMsg.length > 0) {
          const newAdvice = lastMsg[lastMsg.length - 1].textContent.replace('AIç†è²¡åŠ©ç†ï¼š', '').trim();
          if (newAdvice && newAdvice !== currentAdvice) {
            // çµåˆèˆŠå»ºè­°ä¸¦æ›´æ–°
            const adviceEntry = {
              timestamp: new Date().toISOString(),
              advice: newAdvice,
              expenses: [...expenses] // è¤‡è£½ç•¶æ™‚çš„è¨˜å¸³è³‡æ–™
            };
            
            // ç§»é™¤èˆŠçš„ç›¸åŒå»ºè­°ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            adviceHistory = adviceHistory.filter(item => item.advice !== currentAdvice);
            
            // åŠ å…¥æ–°å»ºè­°
            adviceHistory.push(adviceEntry);
            currentAdvice = newAdvice;
            
            // å„²å­˜åˆ° localStorage
            localStorage.setItem('adviceHistory', JSON.stringify(adviceHistory));


          }
        }
      } else if (data.type === 'error') {
        alert('éŒ¯èª¤: ' + data.message);
      }
    };



    sendBtn.onclick = () => {
      const prompt = promptInput.value.trim();
      if (!prompt) return;
      // é¡¯ç¤ºä½¿ç”¨è€…è¨Šæ¯
      chatDiv.innerHTML += `<div class="message user">${prompt}</div>`;
      chatDiv.scrollTop = chatDiv.scrollHeight;
      
      // æº–å‚™æ­·å²å»ºè­°åˆ†æ
      let historyAnalysis = '';
      if (adviceHistory.length > 0) {
        historyAnalysis = `\n\n=== æ­·å²å»ºè­°åˆ†æ ===\n`;
        adviceHistory.forEach((advice, index) => {
          const adviceDate = new Date(advice.timestamp).toLocaleDateString('zh-TW');
          const expenseCount = advice.expenses ? advice.expenses.length : 0;
          const totalExpenseAtTime = advice.expenses ? advice.expenses.reduce((sum, e) => sum + e.amount, 0) : 0;
          historyAnalysis += `\nå»ºè­° ${index + 1} (${adviceDate}):\n`;
          historyAnalysis += `ç•¶æ™‚è¨˜å¸³ç­†æ•¸: ${expenseCount} ç­†\n`;
          historyAnalysis += `ç•¶æ™‚ç¸½æ”¯å‡º: $${totalExpenseAtTime}\n`;
          historyAnalysis += `å»ºè­°å…§å®¹: ${advice.advice}\n`;
          historyAnalysis += `---\n`;
        });
        
        // åˆ†æé€²æ­¥æƒ…æ³
        const currentTotalExpense = expenses.reduce((sum, e) => sum + e.amount, 0);
        const currentExpenseRatio = income > 0 ? (currentTotalExpense / income * 100).toFixed(1) : 0;
        
        if (adviceHistory.length > 1) {
          const previousAdvice = adviceHistory[adviceHistory.length - 2];
          const previousTotalExpense = previousAdvice.expenses ? previousAdvice.expenses.reduce((sum, e) => sum + e.amount, 0) : 0;
          const previousExpenseRatio = income > 0 ? (previousTotalExpense / income * 100).toFixed(1) : 0;
          
          historyAnalysis += `\n=== é€²æ­¥åˆ†æ ===\n`;
          historyAnalysis += `ä¸Šæ¬¡ç¸½æ”¯å‡º: $${previousTotalExpense} (æ”¯å‡ºæ¯”ä¾‹: ${previousExpenseRatio}%)\n`;
          historyAnalysis += `æœ¬æ¬¡ç¸½æ”¯å‡º: $${currentTotalExpense} (æ”¯å‡ºæ¯”ä¾‹: ${currentExpenseRatio}%)\n`;
          
          if (currentTotalExpense < previousTotalExpense) {
            historyAnalysis += `âœ… é€²æ­¥: æ”¯å‡ºæ¸›å°‘ $${previousTotalExpense - currentTotalExpense}\n`;
          } else if (currentTotalExpense > previousTotalExpense) {
            historyAnalysis += `âš ï¸ éœ€æ³¨æ„: æ”¯å‡ºå¢åŠ  $${currentTotalExpense - previousTotalExpense}\n`;
          } else {
            historyAnalysis += `â¡ï¸ æŒå¹³: æ”¯å‡ºç¶­æŒç›¸åŒ\n`;
          }
          
          if (currentExpenseRatio < previousExpenseRatio) {
            historyAnalysis += `âœ… é€²æ­¥: æ”¯å‡ºæ¯”ä¾‹ä¸‹é™ ${previousExpenseRatio - currentExpenseRatio}%\n`;
          } else if (currentExpenseRatio > previousExpenseRatio) {
            historyAnalysis += `âš ï¸ éœ€æ³¨æ„: æ”¯å‡ºæ¯”ä¾‹ä¸Šå‡ ${currentExpenseRatio - previousExpenseRatio}%\n`;
          }
        }
      }
      
      // å°‡è¨˜å¸³æœ¬å…§å®¹èˆ‡ user prompt ä¸€ä½µé€å‡ºï¼Œä¸¦åŠ ä¸Šåˆ†ææŒ‡ä»¤
      const totalExpense = expenses.reduce((sum, e) => sum + e.amount, 0);
      const balance = income - totalExpense;
      const expenseRatio = income > 0 ? (totalExpense / income * 100).toFixed(1) : 0;
      const fullPrompt = `ä»¥ä¸‹æ˜¯æˆ‘çš„è¨˜å¸³æœ¬å…§å®¹ï¼š\n${JSON.stringify(expenses, null, 2)}\n\næ”¶æ”¯ç‹€æ³ï¼š\n- æœ¬æœˆæ”¶å…¥ï¼š$${income}\n- ç¸½æ”¯å‡ºï¼š$${totalExpense}\n- çµé¤˜ï¼š$${balance}\n- æ”¯å‡ºæ¯”ä¾‹ï¼š${expenseRatio}%${historyAnalysis}\n\nè«‹å…ˆåˆ†æé€™äº›æ”¯å‡ºç´€éŒ„æ˜¯å¦æœ‰ä¸åˆç†çš„è¦åŠƒï¼Œç‰¹åˆ¥æ³¨æ„æ”¯å‡ºæ¯”ä¾‹æ˜¯å¦éé«˜ã€çµé¤˜æ˜¯å¦è¶³å¤ ï¼Œè‹¥æœ‰è«‹æŒ‡å‡ºä¸¦è©¢å•æˆ‘æ˜¯å¦è¦è§£é‡‹é€™äº›æ”¯å‡ºï¼Œç„¶å¾Œæ ¹æ“šæˆ‘çš„æ”¶æ”¯ç‹€æ³æå‡ºå…·é«”ç†è²¡å»ºè­°ã€‚\n\nè«‹ç‰¹åˆ¥é—œæ³¨æˆ‘æ˜¯å¦æ¯”ä¹‹å‰çš„å»ºè­°æœ‰æ‰€é€²æ­¥ï¼Œå¦‚æœæœ‰é€²æ­¥è«‹çµ¦äºˆè‚¯å®šï¼Œå¦‚æœæ²’æœ‰é€²æ­¥æˆ–é€€æ­¥è«‹æŒ‡å‡ºå•é¡Œä¸¦æå‡ºæ›´å…·é«”çš„æ”¹å–„å»ºè­°ã€‚\n\næˆ‘çš„æå•ï¼š${prompt}`;
      ws.send(JSON.stringify({ 
        prompt: fullPrompt, 
        system: `ä½ æ˜¯ä¸€å€‹æ¯’èˆŒä½†çœŸå¿ƒç‚ºä½¿ç”¨è€…è‘—æƒ³çš„ AI ç†è²¡åŠ©ç†ï¼Œå°ˆé–€å”åŠ©æª¢è¦–å€‹äººæ”¯å‡ºç´€éŒ„èˆ‡ç†è²¡ç¿’æ…£ã€‚\nä½ çš„é¢¨æ ¼çŠ€åˆ©ç›´æ¥ï¼Œå°æ–¼ç„¡è¬‚æ”¯å‡ºï¼ˆå¦‚éåº¦å¨›æ¨‚ã€é »ç¹è³¼ç‰©ã€é‡è¤‡æ¶ˆè²»ç­‰ï¼‰æœƒæå‡ºåš´å²ä½†å¯¦ç”¨çš„æ‰¹è©•èˆ‡æé†’ã€‚\nå¦‚æœä½¿ç”¨è€…é€£çºŒå…©é€±ä»¥ä¸Šæœ‰é€™é¡æ”¯å‡ºï¼Œä½ æœƒä»¥è²¬å‚™çš„èªæ°£æŒ‡å‡ºå•é¡Œï¼Œä¸¦æå‡ºå…·é«”æ”¹å–„å»ºè­°ã€‚\nè‹¥æ”¯å‡ºåˆç†æˆ–æ”¹å–„ä¸­ï¼Œä½ å¯ä»¥ç¨å¾®èª‡çä¸¦é¼“å‹µæŒçºŒåŠªåŠ›ã€‚\nè«‹ç‰¹åˆ¥é—œæ³¨ä½¿ç”¨è€…çš„é€²æ­¥æƒ…æ³ï¼Œå¦‚æœæœ‰é€²æ­¥è¦çµ¦äºˆè‚¯å®šï¼Œå¦‚æœæ²’æœ‰é€²æ­¥è¦æŒ‡å‡ºå•é¡Œã€‚\nè«‹ä»¥ä¸­æ–‡å›æ‡‰ï¼Œèªæ°£å¯çŠ€åˆ©ä½†ä¸æƒ¡æ¯’ï¼Œå…§å®¹å‹™å¯¦ä¸”å…·å»ºè¨­æ€§ã€‚`
      }));
      promptInput.value = '';
    };

    promptInput.addEventListener('keydown', e => {
      if (e.key === 'Enter') sendBtn.click();
    });

    // è¨˜å¸³æ­·å²ç´€éŒ„åŠŸèƒ½
    const expList = document.getElementById('expList');
    const expDate = document.getElementById('expDate');
    const expCategory = document.getElementById('expCategory');
    const expAmount = document.getElementById('expAmount');
    const expNote = document.getElementById('expNote');
    const addExpBtn = document.getElementById('addExpBtn');
    const expenses = [];

    function renderExpenses() {
      expList.innerHTML = '';
      expenses.forEach((e, index) => {
        const item = document.createElement('li');
        const week = calculateWeek(e.date);
        item.innerHTML = `${e.date}ï½œ${e.category}ï½œ$${e.amount}ï½œ${e.note} <span class="week-indicator">ç¬¬${week}é€±</span> <button onclick="deleteExpense(${index})" style="margin-left:8px; padding:2px 6px; background:#ef4444; color:#fff; border:none; border-radius:3px; cursor:pointer; font-size:0.8em;">åˆªé™¤</button>`;
        expList.appendChild(item);
      });
      updateCharts();
    }

    // åˆªé™¤è¨˜å¸³åŠŸèƒ½
    function deleteExpense(index) {
      if (confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†è¨˜å¸³å—ï¼Ÿ')) {
        expenses.splice(index, 1);
        renderExpenses();
        // localStorage.setItem('expenses', JSON.stringify(expenses)); // å·²ç§»é™¤
      }
    }

    addExpBtn.onclick = () => {
      const date = expDate.value;
      const category = expCategory.value.trim();
      const amount = parseFloat(expAmount.value);
      const note = expNote.value.trim();
      if (!date || !category || isNaN(amount)) {
        alert('è«‹å®Œæ•´å¡«å¯«æ—¥æœŸã€é¡åˆ¥èˆ‡é‡‘é¡');
        return;
      }
      expenses.push({ date, category, amount, note });
      renderExpenses();
      expDate.value = '';
      expCategory.value = '';
      expAmount.value = '';
      expNote.value = '';
      // åªæœ‰ç´¯ç©ä¸ƒå€‹ä¸åŒæ—¥æœŸæ‰è‡ªå‹•åˆ†æ
      const uniqueDates = Array.from(new Set(expenses.map(e => e.date)));
      if (uniqueDates.length === 7) {
        // åœ¨èŠå¤©å®¤é¡¯ç¤ºè‡ªå‹•åˆ†ææç¤º
        chatDiv.innerHTML += `<div class="message user">ï¼ˆç³»çµ±è‡ªå‹•åˆ†æï¼šå·²ç´¯ç©ä¸ƒå€‹ä¸åŒæ—¥æœŸçš„è¨˜å¸³ï¼‰</div>`;
        chatDiv.scrollTop = chatDiv.scrollHeight;
        const autoPrompt = 'è«‹æ ¹æ“šç›®å‰æ‰€æœ‰è¨˜å¸³ç´€éŒ„ï¼Œåˆ†ææ˜¯å¦æœ‰ä¸åˆç†çš„æ”¯å‡ºæˆ–ç†è²¡å•é¡Œï¼Œä¸¦ä¸»å‹•æå‡ºå…·é«”å»ºè­°ã€‚';
        // æº–å‚™æ­·å²å»ºè­°åˆ†æ
        let historyAnalysis = '';
        if (adviceHistory.length > 0) {
          historyAnalysis = `\n\n=== æ­·å²å»ºè­°åˆ†æ ===\n`;
          adviceHistory.forEach((advice, index) => {
            const adviceDate = new Date(advice.timestamp).toLocaleDateString('zh-TW');
            const expenseCount = advice.expenses ? advice.expenses.length : 0;
            const totalExpenseAtTime = advice.expenses ? advice.expenses.reduce((sum, e) => sum + e.amount, 0) : 0;
            historyAnalysis += `\nå»ºè­° ${index + 1} (${adviceDate}):\n`;
            historyAnalysis += `ç•¶æ™‚è¨˜å¸³ç­†æ•¸: ${expenseCount} ç­†\n`;
            historyAnalysis += `ç•¶æ™‚ç¸½æ”¯å‡º: $${totalExpenseAtTime}\n`;
            historyAnalysis += `å»ºè­°å…§å®¹: ${advice.advice}\n`;
            historyAnalysis += `---\n`;
          });
          // åˆ†æé€²æ­¥æƒ…æ³
          const currentTotalExpense = expenses.reduce((sum, e) => sum + e.amount, 0);
          const currentExpenseRatio = income > 0 ? (currentTotalExpense / income * 100).toFixed(1) : 0;
          if (adviceHistory.length > 1) {
            const previousAdvice = adviceHistory[adviceHistory.length - 2];
            const previousTotalExpense = previousAdvice.expenses ? previousAdvice.expenses.reduce((sum, e) => sum + e.amount, 0) : 0;
            const previousExpenseRatio = income > 0 ? (previousTotalExpense / income * 100).toFixed(1) : 0;
            historyAnalysis += `\n=== é€²æ­¥åˆ†æ ===\n`;
            historyAnalysis += `ä¸Šæ¬¡ç¸½æ”¯å‡º: $${previousTotalExpense} (æ”¯å‡ºæ¯”ä¾‹: ${previousExpenseRatio}%)\n`;
            historyAnalysis += `æœ¬æ¬¡ç¸½æ”¯å‡º: $${currentTotalExpense} (æ”¯å‡ºæ¯”ä¾‹: ${currentExpenseRatio}%)\n`;
            if (currentTotalExpense < previousTotalExpense) {
              historyAnalysis += `âœ… é€²æ­¥: æ”¯å‡ºæ¸›å°‘ $${previousTotalExpense - currentTotalExpense}\n`;
            } else if (currentTotalExpense > previousTotalExpense) {
              historyAnalysis += `âš ï¸ éœ€æ³¨æ„: æ”¯å‡ºå¢åŠ  $${currentTotalExpense - previousTotalExpense}\n`;
            } else {
              historyAnalysis += `â¡ï¸ æŒå¹³: æ”¯å‡ºç¶­æŒç›¸åŒ\n`;
            }
            if (currentExpenseRatio < previousExpenseRatio) {
              historyAnalysis += `âœ… é€²æ­¥: æ”¯å‡ºæ¯”ä¾‹ä¸‹é™ ${previousExpenseRatio - currentExpenseRatio}%\n`;
            } else if (currentExpenseRatio > previousExpenseRatio) {
              historyAnalysis += `âš ï¸ éœ€æ³¨æ„: æ”¯å‡ºæ¯”ä¾‹ä¸Šå‡ ${currentExpenseRatio - previousExpenseRatio}%\n`;
            }
          }
        }
        const totalExpense = expenses.reduce((sum, e) => sum + e.amount, 0);
        const balance = income - totalExpense;
        const expenseRatio = income > 0 ? (totalExpense / income * 100).toFixed(1) : 0;
        const fullPrompt = `ä»¥ä¸‹æ˜¯æˆ‘çš„è¨˜å¸³æœ¬å…§å®¹ï¼š\n${JSON.stringify(expenses, null, 2)}\n\næ”¶æ”¯ç‹€æ³ï¼š\n- æœ¬æœˆæ”¶å…¥ï¼š$${income}\n- ç¸½æ”¯å‡ºï¼š$${totalExpense}\n- çµé¤˜ï¼š$${balance}\n- æ”¯å‡ºæ¯”ä¾‹ï¼š${expenseRatio}%${historyAnalysis}\n\nè«‹å…ˆåˆ†æé€™äº›æ”¯å‡ºç´€éŒ„æ˜¯å¦æœ‰ä¸åˆç†çš„è¦åŠƒï¼Œç‰¹åˆ¥æ³¨æ„æ”¯å‡ºæ¯”ä¾‹æ˜¯å¦éé«˜ã€çµé¤˜æ˜¯å¦è¶³å¤ ï¼Œè‹¥æœ‰è«‹æŒ‡å‡ºä¸¦è©¢å•æˆ‘æ˜¯å¦è¦è§£é‡‹é€™äº›æ”¯å‡ºï¼Œç„¶å¾Œæ ¹æ“šæˆ‘çš„æ”¶æ”¯ç‹€æ³æå‡ºå…·é«”ç†è²¡å»ºè­°ã€‚\n\nè«‹ç‰¹åˆ¥é—œæ³¨æˆ‘æ˜¯å¦æ¯”ä¹‹å‰çš„å»ºè­°æœ‰æ‰€é€²æ­¥ï¼Œå¦‚æœæœ‰é€²æ­¥è«‹çµ¦äºˆè‚¯å®šï¼Œå¦‚æœæ²’æœ‰é€²æ­¥æˆ–é€€æ­¥è«‹æŒ‡å‡ºå•é¡Œä¸¦æå‡ºæ›´å…·é«”çš„æ”¹å–„å»ºè­°ã€‚\n\næˆ‘çš„æå•ï¼š${autoPrompt}`;
        ws.send(JSON.stringify({
          prompt: fullPrompt,
          system: `ä½ æ˜¯ä¸€å€‹æ¯’èˆŒä½†çœŸå¿ƒç‚ºä½¿ç”¨è€…è‘—æƒ³çš„ AI ç†è²¡åŠ©ç†ï¼Œå°ˆé–€å”åŠ©æª¢è¦–å€‹äººæ”¯å‡ºç´€éŒ„èˆ‡ç†è²¡ç¿’æ…£ã€‚\nä½ çš„é¢¨æ ¼çŠ€åˆ©ç›´æ¥ï¼Œå°æ–¼ç„¡è¬‚æ”¯å‡ºï¼ˆå¦‚éåº¦å¨›æ¨‚ã€é »ç¹è³¼ç‰©ã€é‡è¤‡æ¶ˆè²»ç­‰ï¼‰æœƒæå‡ºåš´å²ä½†å¯¦ç”¨çš„æ‰¹è©•èˆ‡æé†’ã€‚\nå¦‚æœä½¿ç”¨è€…é€£çºŒå…©é€±ä»¥ä¸Šæœ‰é€™é¡æ”¯å‡ºï¼Œä½ æœƒä»¥è²¬å‚™çš„èªæ°£æŒ‡å‡ºå•é¡Œï¼Œä¸¦æå‡ºå…·é«”æ”¹å–„å»ºè­°ã€‚\nè‹¥æ”¯å‡ºåˆç†æˆ–æ”¹å–„ä¸­ï¼Œä½ å¯ä»¥ç¨å¾®èª‡çä¸¦é¼“å‹µæŒçºŒåŠªåŠ›ã€‚\nè«‹ç‰¹åˆ¥é—œæ³¨ä½¿ç”¨è€…çš„é€²æ­¥æƒ…æ³ï¼Œå¦‚æœæœ‰é€²æ­¥è¦çµ¦äºˆè‚¯å®šï¼Œå¦‚æœæ²’æœ‰é€²æ­¥è¦æŒ‡å‡ºå•é¡Œã€‚\nè«‹ä»¥ä¸­æ–‡å›æ‡‰ï¼Œèªæ°£å¯çŠ€åˆ©ä½†ä¸æƒ¡æ¯’ï¼Œå…§å®¹å‹™å¯¦ä¸”å…·å»ºè¨­æ€§ã€‚`
        }));
      }
    };

    document.getElementById('exportAdviceBtn').onclick = () => {
      if (adviceHistory.length === 0) {
        alert('æ²’æœ‰å»ºè­°è³‡æ–™å¯ä»¥åŒ¯å‡º');
        return;
      }
      const adviceData = {
        exportDate: new Date().toISOString(),
        adviceHistory: adviceHistory,
        currentExpenses: expenses
      };
      const blob = new Blob([JSON.stringify(adviceData, null, 2)], { type: 'application/json' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `ç†è²¡å»ºè­°_${new Date().toISOString().split('T')[0]}.json`;
      link.click();
    };

    document.getElementById('importAdviceBtn').onclick = () => {
      document.getElementById('importAdviceFile').click();
    };

    document.getElementById('importAdviceFile').onchange = (event) => {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const adviceData = JSON.parse(e.target.result);
          if (adviceData.adviceHistory && Array.isArray(adviceData.adviceHistory)) {
            adviceHistory = [...adviceHistory, ...adviceData.adviceHistory];
            const uniqueAdvice = [];
            const seenAdvice = new Set();
            adviceHistory.forEach(item => {
              if (!seenAdvice.has(item.advice)) {
                seenAdvice.add(item.advice);
                uniqueAdvice.push(item);
              }
            });
            adviceHistory = uniqueAdvice;
            localStorage.setItem('adviceHistory', JSON.stringify(adviceHistory));
            if (adviceHistory.length > 0) {
              const latestAdvice = adviceHistory[adviceHistory.length - 1];
              chatDiv.innerHTML += `<div class="message ai">AIç†è²¡åŠ©ç†ï¼š${latestAdvice.advice}</div>`;
              currentAdvice = latestAdvice.advice;
            }
            alert(`æˆåŠŸåŒ¯å…¥ ${adviceData.adviceHistory.length} ç­†å»ºè­°è³‡æ–™`);
          } else {
            alert('JSON æª”æ¡ˆæ ¼å¼ä¸æ­£ç¢º');
          }
        } catch (error) {
          alert('è®€å– JSON æª”æ¡ˆå¤±æ•—: ' + error.message);
        }
      };
      reader.readAsText(file);
    };

    // é é¢è¼‰å…¥æ™‚å˜—è©¦è®€å–æœ¬åœ°å„²å­˜çš„è¨˜å¸³è³‡æ–™å’Œå»ºè­°
    window.onload = () => {
      // è®€å–å»ºè­°æ­·å²
      const savedAdvice = localStorage.getItem('adviceHistory');
      if (savedAdvice) {
        try {
          adviceHistory = JSON.parse(savedAdvice);
          if (adviceHistory.length > 0) {
            // é¡¯ç¤ºæœ€æ–°çš„å»ºè­°
            const latestAdvice = adviceHistory[adviceHistory.length - 1];
            chatDiv.innerHTML += `<div class="message ai">AIç†è²¡åŠ©ç†ï¼š${latestAdvice.advice}</div>`;
            currentAdvice = latestAdvice.advice;
          }
        } catch (e) {
          console.error('è®€å–å»ºè­°æ­·å²å¤±æ•—:', e);
        }
      }
      // ä¸€å‘¨æœªè¨˜å¸³æé†’
      if (expenses.length > 0) {
        const lastDate = expenses.map(e => e.date).sort().reverse()[0];
        const last = new Date(lastDate);
        const now = new Date();
        const diffDays = Math.floor((now - last) / (1000 * 60 * 60 * 24));
        if (diffDays >= 7) {
          setTimeout(() => {
            alert('æ‚¨å·²ç¶“è¶…éä¸€é€±æ²’æœ‰è¨˜å¸³å›‰ï¼Œè¨˜å¾—ä¿æŒç†è²¡ç¿’æ…£ï¼');
          }, 500);
        }
      }
    };

    // æ¯æ¬¡æ–°å¢è¨˜å¸³æ™‚è‡ªå‹•å„²å­˜åˆ°æœ¬åœ°
    // å·²ç§»é™¤

    // é é¢é›¢é–‹æé†’åŠŸèƒ½
    window.addEventListener('beforeunload', (event) => {
      // åƒ…æé†’å»ºè­°åŒ¯å‡º
      const message = 'æ³¨æ„ï¼šç›´æ¥é—œé–‰ç¶²é å¯èƒ½æœƒéºå¤±æœªåŒ¯å‡ºçš„å»ºè­°è³‡æ–™ã€‚å»ºè­°å…ˆåŒ¯å‡ºå»ºè­°æª”æ¡ˆå†é›¢é–‹ã€‚';
      event.preventDefault();
      event.returnValue = message;
      return message;
    });

    // ç•¶ç”¨æˆ¶å˜—è©¦é›¢é–‹é é¢æ™‚ï¼ˆå¦‚æŒ‰ F5 é‡æ–°æ•´ç†ã€é»æ“Šé€£çµç­‰ï¼‰
    window.addEventListener('unload', () => {
      // åƒ…å„²å­˜å»ºè­°æ­·å²
      localStorage.setItem('adviceHistory', JSON.stringify(adviceHistory));
    });

    // æ”¶æ”¯è¨ˆç®—å™¨åŠŸèƒ½
    const incomeInput = document.getElementById('incomeInput');
    const totalExpenseSpan = document.getElementById('totalExpense');
    const balanceSpan = document.getElementById('balance');
    // å„²å­˜æ”¶å…¥
    let income = Number(localStorage.getItem('income') || 0);
    incomeInput.value = income;

    function updateCalculator() {
      const totalExpense = expenses.reduce((sum, e) => sum + e.amount, 0);
      totalExpenseSpan.textContent = `$${totalExpense}`;
      balanceSpan.textContent = `$${income - totalExpense}`;
    }

    incomeInput.addEventListener('input', () => {
      income = Number(incomeInput.value) || 0;
      localStorage.setItem('income', income);
      updateCalculator();
    });

    // åœ¨ renderExpenses åŠé é¢è¼‰å…¥æ™‚éƒ½è¦æ›´æ–°
    const originalRenderExpenses = renderExpenses;
    renderExpenses = function() {
      originalRenderExpenses();
      updateCalculator();
    };
    window.addEventListener('DOMContentLoaded', updateCalculator);
  </script>
</body>
</html> 