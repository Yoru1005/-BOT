<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AIÁêÜË≤°Âä©ÁêÜ</title>
  <style>
    body {
      font-family: 'Segoe UI', 'Noto Sans TC', Arial, sans-serif;
      background: linear-gradient(135deg, #e0e7ff 0%, #f8fafc 100%);
      padding: 0;
      margin: 0;
      min-height: 100vh;
      transition: all 0.3s ease;
    }
    body.dark-mode {
      background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
    }
    .container {
      max-width: 540px;
      margin: 40px auto 0 auto;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 4px 24px 0 rgba(60,72,88,0.10);
      padding: 32px 24px 24px 24px;
      min-height: 80vh;
      transition: all 0.3s ease;
    }
    body.dark-mode .container {
      background: #1e293b;
      box-shadow: 0 4px 24px 0 rgba(0,0,0,0.3);
    }
    .theme-toggle {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #6366f1;
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      cursor: pointer;
      font-size: 18px;
      box-shadow: 0 2px 8px 0 #e0e7ff;
      transition: all 0.3s ease;
    }
    body.dark-mode .theme-toggle {
      background: #f59e0b;
    }
    h1 {
      text-align: center;
      color: #3b3b4f;
      margin-bottom: 24px;
      letter-spacing: 2px;
      transition: color 0.3s ease;
    }
    body.dark-mode h1 {
      color: #f1f5f9;
    }
    #chat {
      white-space: pre-wrap;
      border: 1px solid #e5e7eb;
      background: #f4f7fb;
      padding: 16px;
      max-height: 320px;
      overflow-y: auto;
      margin-bottom: 16px;
      border-radius: 8px;
      font-size: 1.05em;
      box-shadow: 0 1px 2px 0 #e0e7ff;
      transition: all 0.3s ease;
    }
    body.dark-mode #chat {
      border: 1px solid #334155;
      background: #334155;
      color: #f1f5f9;
    }
    .message.user {
      color: #2563eb;
      margin-bottom: 8px;
      text-align: right;
      font-weight: 500;
      transition: color 0.3s ease;
    }
    body.dark-mode .message.user {
      color: #60a5fa;
    }
    .message.ai {
      color: #374151;
      margin-bottom: 8px;
      text-align: left;
      background: #e0e7ff;
      display: inline-block;
      padding: 8px 14px;
      border-radius: 12px 12px 12px 0;
      max-width: 90%;
      box-shadow: 0 1px 2px 0 #e0e7ff;
      transition: all 0.3s ease;
    }
    body.dark-mode .message.ai {
      background: #475569;
      color: #f1f5f9;
    }
    .week-indicator {
      background: #fef3c7;
      color: #92400e;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.8em;
      margin-left: 8px;
      transition: all 0.3s ease;
    }
    body.dark-mode .week-indicator {
      background: #451a03;
      color: #fbbf24;
    }
    .charts-container {
      display: flex;
      gap: 16px;
      margin: 16px 0;
      flex-wrap: wrap;
    }
    .chart {
      flex: 1;
      min-width: 200px;
      background: #f8fafc;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 16px;
      transition: all 0.3s ease;
    }
    body.dark-mode .chart {
      background: #334155;
      border: 1px solid #475569;
    }
    .chart h3 {
      margin: 0 0 12px 0;
      color: #374151;
      font-size: 1em;
      transition: color 0.3s ease;
    }
    body.dark-mode .chart h3 {
      color: #f1f5f9;
    }
    .bar-chart {
      height: 120px;
      display: flex;
      align-items: end;
      gap: 4px;
      padding: 8px 0;
    }
    .bar {
      flex: 1;
      background: linear-gradient(to top, #6366f1, #8b5cf6);
      border-radius: 2px 2px 0 0;
      min-height: 4px;
      transition: all 0.3s ease;
    }
    .pie-chart {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      margin: 0 auto;
      background: conic-gradient(
        #6366f1 0deg 90deg,
        #8b5cf6 90deg 180deg,
        #ec4899 180deg 270deg,
        #f59e0b 270deg 360deg
      );
      position: relative;
    }
    .pie-chart::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 60px;
      height: 60px;
      background: #f8fafc;
      border-radius: 50%;
      transition: background 0.3s ease;
    }
    body.dark-mode .pie-chart::before {
      background: #334155;
    }

    #prompt {
      width: 70%;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #cbd5e1;
      font-size: 1em;
      margin-right: 8px;
      background: #f8fafc;
      transition: all 0.3s ease;
    }
    body.dark-mode #prompt {
      background: #475569;
      border: 1px solid #64748b;
      color: #f1f5f9;
    }
    #prompt:focus {
      border: 1.5px solid #6366f1;
      outline: none;
      background: #fff;
    }
    body.dark-mode #prompt:focus {
      background: #334155;
    }
    #sendBtn {
      padding: 10px 22px;
      border-radius: 6px;
      border: none;
      background: linear-gradient(90deg, #6366f1 0%, #2563eb 100%);
      color: #fff;
      font-weight: 600;
      font-size: 1em;
      cursor: pointer;
      transition: background 0.2s;
      box-shadow: 0 2px 8px 0 #e0e7ff;
    }
    #sendBtn:disabled {
      background: #a5b4fc;
      cursor: not-allowed;
    }
    hr {
      margin: 32px 0 18px 0;
      border: none;
      border-top: 1.5px solid #e5e7eb;
      transition: border-color 0.3s ease;
    }
    body.dark-mode hr {
      border-top-color: #475569;
    }
    h2 {
      color: #6366f1;
      margin-bottom: 12px;
      font-size: 1.18em;
      letter-spacing: 1px;
      transition: color 0.3s ease;
    }
    body.dark-mode h2 {
      color: #a78bfa;
    }
    .exp-form {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }
    .exp-form input[type="date"],
    .exp-form input[type="text"],
    .exp-form input[type="number"] {
      padding: 7px 8px;
      border-radius: 5px;
      border: 1px solid #cbd5e1;
      font-size: 1em;
      background: #f8fafc;
      transition: all 0.3s ease;
    }
    body.dark-mode .exp-form input[type="date"],
    body.dark-mode .exp-form input[type="text"],
    body.dark-mode .exp-form input[type="number"] {
      background: #475569;
      border: 1px solid #64748b;
      color: #f1f5f9;
    }
    .exp-form input:focus {
      border: 1.5px solid #6366f1;
      outline: none;
      background: #fff;
    }
    body.dark-mode .exp-form input:focus {
      background: #334155;
    }
    #addExpBtn {
      padding: 7px 18px;
      border-radius: 5px;
      border: none;
      background: linear-gradient(90deg, #22d3ee 0%, #6366f1 100%);
      color: #fff;
      font-weight: 600;
      font-size: 1em;
      cursor: pointer;
      transition: background 0.2s;
      box-shadow: 0 1px 4px 0 #e0e7ff;
    }
    #addExpBtn:active {
      background: #2563eb;
    }
    #expList {
      background: #f8fafc;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 12px 10px;
      min-height: 40px;
      margin-bottom: 10px;
      font-size: 1em;
      box-shadow: 0 1px 2px 0 #e0e7ff;
      transition: all 0.3s ease;
    }
    body.dark-mode #expList {
      background: #334155;
      border: 1px solid #475569;
      color: #f1f5f9;
    }
    #expList li {
      margin-bottom: 6px;
      color: #374151;
      letter-spacing: 0.5px;
      transition: color 0.3s ease;
    }
    body.dark-mode #expList li {
      color: #f1f5f9;
    }
    .exp-btns button {
      margin-right: 8px;
      padding: 6px 12px;
      border-radius: 4px;
      border: none;
      font-size: 0.98em;
      cursor: pointer;
            transition: background 0.2s;
    }
    #exportAdviceBtn {
      background: #ffffff;
      color: #000000;
      border: 1px solid #d1d5db;
      box-shadow: 0 1px 4px 0 #e0e7ff;
    }
    #importAdviceBtn {
      background: #ffffff;
      color: #000000;
      border: 1px solid #d1d5db;
      box-shadow: 0 1px 4px 0 #e0e7ff;
    }
    #exportAdviceBtn:hover, #importAdviceBtn:hover {
      background: #f9fafb;
      border-color: #9ca3af;
    }
    @media (max-width: 600px) {
      .container { padding: 10px 2vw; }
      #prompt { width: 100%; margin-bottom: 8px; }
      #sendBtn { width: 100%; }
      .exp-form { flex-direction: column; gap: 6px; }
      .charts-container { flex-direction: column; }
    }
  </style>
</head>
<body>
  <button class="theme-toggle" onclick="toggleTheme()">üåô</button>
  <div class="container">
    <h1>AIÁêÜË≤°Âä©ÁêÜ</h1>
    <div id="chat"></div>
    <div style="display:flex; gap:8px; margin-bottom:8px; flex-wrap:wrap;">
      <input id="prompt" type="text" placeholder="Ëº∏ÂÖ•Ë®äÊÅØ..." />
      <button id="sendBtn">ÈÄÅÂá∫</button>
    </div>
    <div class="charts-container" id="chartsContainer" style="display:none;">
      <div class="chart">
        <h3>ÊîØÂá∫È°ûÂûãÂàÜÂ∏É</h3>
        <div class="pie-chart"></div>
        <div style="display:flex; justify-content:space-between; margin-top:10px; font-size:0.95em;">
          <span style="color:#6366f1;">È£ü</span>
          <span style="color:#8b5cf6;">Ë°£</span>
          <span style="color:#10b981;">‰Ωè</span>
          <span style="color:#f59e0b;">Ë°å</span>
          <span style="color:#ec4899;">Â®õÊ®Ç</span>
          <span style="color:#64748b;">ÂÖ∂‰ªñ</span>
        </div>
      </div>
      <div class="chart" style="min-width:180px;">
        <h3>Êî∂ÊîØË®àÁÆóÂô®</h3>
        <div style="margin-bottom:8px;">
          <label>Êú¨ÊúàÊî∂ÂÖ•Ôºö<input type="number" id="incomeInput" style="width:90px; padding:4px 6px; border-radius:4px; border:1px solid #cbd5e1;" min="0" /></label>
        </div>
        <div style="margin-bottom:6px;">Á∏ΩÊîØÂá∫Ôºö<span id="totalExpense" style="color:#ef4444; font-weight:600;">$0</span></div>
        <div>ÁµêÈ§òÔºö<span id="balance" style="color:#10b981; font-weight:600;">$0</span></div>
      </div>
    </div>
    <hr>
    <h2>Ë®òÂ∏≥Ê≠∑Âè≤Á¥ÄÈåÑ</h2>
    <form class="exp-form" onsubmit="return false;">
      <input type="date" id="expDate" />
      <select id="expCategory">
        <option value="È£ü">È£ü</option>
        <option value="Ë°£">Ë°£</option>
        <option value="‰Ωè">‰Ωè</option>
        <option value="Ë°å">Ë°å</option>
        <option value="Â®õÊ®Ç">Â®õÊ®Ç</option>
        <option value="ÂÖ∂‰ªñ">ÂÖ∂‰ªñ</option>
      </select>
      <input type="number" id="expAmount" placeholder="ÈáëÈ°ç" style="width:80px;" />
      <input type="text" id="expNote" placeholder="ÂÇôË®ª" />
      <button id="addExpBtn">Êñ∞Â¢û</button>
    </form>
        <ul id="expList"></ul>
    <div class="exp-btns">
      <button id="exportAdviceBtn">ÂåØÂá∫Âª∫Ë≠∞</button>
      <input type="file" id="importAdviceFile" accept=".json" style="display:none;" />
      <button id="importAdviceBtn">ÂåØÂÖ•Âª∫Ë≠∞</button>
    </div>
    </div>
  <script>
    const ws = new WebSocket(`wss://hshgpt.webduino.tw`);
    const chatDiv = document.getElementById('chat');
    const promptInput = document.getElementById('prompt');
    const sendBtn = document.getElementById('sendBtn');
    const chartsContainer = document.getElementById('chartsContainer');

    // Âª∫Ë≠∞ÁÆ°ÁêÜ
    let adviceHistory = [];
    let currentAdvice = '';
    let currentWeek = 1;

    // ‰∏ªÈ°åÂàáÊèõ
    function toggleTheme() {
      document.body.classList.toggle('dark-mode');
      const themeBtn = document.querySelector('.theme-toggle');
      if (document.body.classList.contains('dark-mode')) {
        themeBtn.textContent = '‚òÄÔ∏è';
        localStorage.setItem('theme', 'dark');
      } else {
        themeBtn.textContent = 'üåô';
        localStorage.setItem('theme', 'light');
      }
    }

    // ËºâÂÖ•‰∏ªÈ°åË®≠ÂÆö
    if (localStorage.getItem('theme') === 'dark') {
      document.body.classList.add('dark-mode');
      document.querySelector('.theme-toggle').textContent = '‚òÄÔ∏è';
    }

    // Ë®àÁÆóÈÄ±Ê¨°
    function calculateWeek(dateStr) {
      const date = new Date(dateStr);
      const startOfYear = new Date(date.getFullYear(), 0, 1);
      const days = Math.floor((date - startOfYear) / (24 * 60 * 60 * 1000));
      return Math.ceil((days + startOfYear.getDay() + 1) / 7);
    }

    // Êõ¥Êñ∞ÂúñË°®
    function updateCharts() {
      if (expenses.length === 0) {
        chartsContainer.style.display = 'none';
        return;
      }

      chartsContainer.style.display = 'flex';

      // ÂÖ≠Â§ßÈ°ûÂûãÂõ∫ÂÆöÈ°èËâ≤È†ÜÂ∫è
      const categoryList = ['È£ü', 'Ë°£', '‰Ωè', 'Ë°å', 'Â®õÊ®Ç', 'ÂÖ∂‰ªñ'];
      const colorList = ['#6366f1', '#8b5cf6', '#10b981', '#f59e0b', '#ec4899', '#64748b'];
      const categoryTotals = { È£ü:0, Ë°£:0, ‰Ωè:0, Ë°å:0, Â®õÊ®Ç:0, ÂÖ∂‰ªñ:0 };
      expenses.forEach(exp => {
        if (categoryTotals.hasOwnProperty(exp.category)) {
          categoryTotals[exp.category] += exp.amount;
        }
      });

      // Êõ¥Êñ∞ÂúìÈ§ÖÂúñ
      const pieChart = document.querySelector('.pie-chart');
      const total = Object.values(categoryTotals).reduce((a, b) => a + b, 0);
      let conicGradient = '';
      let currentAngle = 0;
      categoryList.forEach((category, index) => {
        const value = categoryTotals[category];
        const percentage = total ? (value / total) * 360 : 0;
        conicGradient += `${colorList[index]} ${currentAngle}deg ${currentAngle + percentage}deg`;
        if (index < categoryList.length - 1) conicGradient += ', ';
        currentAngle += percentage;
      });
      pieChart.style.background = `conic-gradient(${conicGradient})`;
    }

    ws.onopen = () => console.log('WebSocket Â∑≤ÈÄ£Á∑ö');
    ws.onerror = err => console.error('WebSocket ÈåØË™§', err);
    ws.onclose = () => console.log('WebSocket Â∑≤Êñ∑Á∑ö');

    ws.onmessage = event => {
      const data = JSON.parse(event.data);
      if (data.type === 'start') {
        // È°ØÁ§∫ AI ÂõûÊáâÂÆπÂô®‰∏¶Á¶ÅÁî®Ëº∏ÂÖ•
        chatDiv.innerHTML += '<div class="message ai"></div>';
        promptInput.disabled = true;
        sendBtn.disabled = true;
      } else if (data.type === 'chunk') {
        // Êõ¥Êñ∞ÊúÄÂæå‰∏ÄÂâá AI ÂõûÊáâÔºåÂâçÈù¢Âä†‰∏ä AIÁêÜË≤°Âä©ÁêÜÔºöÂâçÁ∂¥ÔºàÂÉÖÁ¨¨‰∏ÄÊ¨° chunk ÊôÇÂä†Ôºâ
        const msgs = chatDiv.querySelectorAll('.message.ai');
        if (msgs.length > 0) {
          if (msgs[msgs.length - 1].textContent === '') {
            msgs[msgs.length - 1].textContent = 'AIÁêÜË≤°Âä©ÁêÜÔºö';
          }
          // ÈÅéÊøæÊéâÁ≥ªÁµ±Ë®äÊÅØ
          const filteredDelta = data.delta
            .replace(/Ê≠£Âú®ÂÇ≥ÈÄÅ prompt Âà∞ Azure OpenAI \(.*?\)\.\.\./g, '')
            .replace(/Azure OpenAI ÂõûÊáâ:/g, '')
            .replace(/--- ÂõûÊáâÁµêÊùü ---/g, '');
          if (filteredDelta.trim() !== '') {
            msgs[msgs.length - 1].textContent += filteredDelta;
            chatDiv.scrollTop = chatDiv.scrollHeight;
          }
        }
      } else if (data.type === 'end') {
        // ÂõûÊáâÁµêÊùüÔºåÊÅ¢Âæ©Ëº∏ÂÖ•‰∏¶ÂÑ≤Â≠òÂª∫Ë≠∞
        promptInput.disabled = false;
        sendBtn.disabled = false;
        promptInput.focus();
        
        // ÂÑ≤Â≠òÊñ∞ÁöÑÂª∫Ë≠∞
        const lastMsg = chatDiv.querySelectorAll('.message.ai');
        if (lastMsg.length > 0) {
          const newAdvice = lastMsg[lastMsg.length - 1].textContent.replace('AIÁêÜË≤°Âä©ÁêÜÔºö', '').trim();
          if (newAdvice && newAdvice !== currentAdvice) {
            // ÁµêÂêàËàäÂª∫Ë≠∞‰∏¶Êõ¥Êñ∞
            const adviceEntry = {
              timestamp: new Date().toISOString(),
              advice: newAdvice,
              expenses: [...expenses] // Ë§áË£ΩÁï∂ÊôÇÁöÑË®òÂ∏≥Ë≥áÊñô
            };
            
            // ÁßªÈô§ËàäÁöÑÁõ∏ÂêåÂª∫Ë≠∞ÔºàÂ¶ÇÊûúÂ≠òÂú®Ôºâ
            adviceHistory = adviceHistory.filter(item => item.advice !== currentAdvice);
            
            // Âä†ÂÖ•Êñ∞Âª∫Ë≠∞
            adviceHistory.push(adviceEntry);
            currentAdvice = newAdvice;
            
            // ÂÑ≤Â≠òÂà∞ localStorage
            localStorage.setItem('adviceHistory', JSON.stringify(adviceHistory));


          }
        }
      } else if (data.type === 'error') {
        alert('ÈåØË™§: ' + data.message);
      }
    };



    sendBtn.onclick = () => {
      const prompt = promptInput.value.trim();
      if (!prompt) return;
      // È°ØÁ§∫‰ΩøÁî®ËÄÖË®äÊÅØ
      chatDiv.innerHTML += `<div class="message user">${prompt}</div>`;
      chatDiv.scrollTop = chatDiv.scrollHeight;
      
      // Ê∫ñÂÇôÊ≠∑Âè≤Âª∫Ë≠∞ÂàÜÊûê
      let historyAnalysis = '';
      if (adviceHistory.length > 0) {
        historyAnalysis = `\n\n=== Ê≠∑Âè≤Âª∫Ë≠∞ÂàÜÊûê ===\n`;
        adviceHistory.forEach((advice, index) => {
          const adviceDate = new Date(advice.timestamp).toLocaleDateString('zh-TW');
          const expenseCount = advice.expenses ? advice.expenses.length : 0;
          const totalExpenseAtTime = advice.expenses ? advice.expenses.reduce((sum, e) => sum + e.amount, 0) : 0;
          historyAnalysis += `\nÂª∫Ë≠∞ ${index + 1} (${adviceDate}):\n`;
          historyAnalysis += `Áï∂ÊôÇË®òÂ∏≥Á≠ÜÊï∏: ${expenseCount} Á≠Ü\n`;
          historyAnalysis += `Áï∂ÊôÇÁ∏ΩÊîØÂá∫: $${totalExpenseAtTime}\n`;
          historyAnalysis += `Âª∫Ë≠∞ÂÖßÂÆπ: ${advice.advice}\n`;
          historyAnalysis += `---\n`;
        });
        
        // ÂàÜÊûêÈÄ≤Ê≠•ÊÉÖÊ≥Å
        const currentTotalExpense = expenses.reduce((sum, e) => sum + e.amount, 0);
        const currentExpenseRatio = income > 0 ? (currentTotalExpense / income * 100).toFixed(1) : 0;
        
        if (adviceHistory.length > 1) {
          const previousAdvice = adviceHistory[adviceHistory.length - 2];
          const previousTotalExpense = previousAdvice.expenses ? previousAdvice.expenses.reduce((sum, e) => sum + e.amount, 0) : 0;
          const previousExpenseRatio = income > 0 ? (previousTotalExpense / income * 100).toFixed(1) : 0;
          
          historyAnalysis += `\n=== ÈÄ≤Ê≠•ÂàÜÊûê ===\n`;
          historyAnalysis += `‰∏äÊ¨°Á∏ΩÊîØÂá∫: $${previousTotalExpense} (ÊîØÂá∫ÊØî‰æã: ${previousExpenseRatio}%)\n`;
          historyAnalysis += `Êú¨Ê¨°Á∏ΩÊîØÂá∫: $${currentTotalExpense} (ÊîØÂá∫ÊØî‰æã: ${currentExpenseRatio}%)\n`;
          
          if (currentTotalExpense < previousTotalExpense) {
            historyAnalysis += `‚úÖ ÈÄ≤Ê≠•: ÊîØÂá∫Ê∏õÂ∞ë $${previousTotalExpense - currentTotalExpense}\n`;
          } else if (currentTotalExpense > previousTotalExpense) {
            historyAnalysis += `‚ö†Ô∏è ÈúÄÊ≥®ÊÑè: ÊîØÂá∫Â¢ûÂä† $${currentTotalExpense - previousTotalExpense}\n`;
          } else {
            historyAnalysis += `‚û°Ô∏è ÊåÅÂπ≥: ÊîØÂá∫Á∂≠ÊåÅÁõ∏Âêå\n`;
          }
          
          if (currentExpenseRatio < previousExpenseRatio) {
            historyAnalysis += `‚úÖ ÈÄ≤Ê≠•: ÊîØÂá∫ÊØî‰æã‰∏ãÈôç ${previousExpenseRatio - currentExpenseRatio}%\n`;
          } else if (currentExpenseRatio > previousExpenseRatio) {
            historyAnalysis += `‚ö†Ô∏è ÈúÄÊ≥®ÊÑè: ÊîØÂá∫ÊØî‰æã‰∏äÂçá ${currentExpenseRatio - previousExpenseRatio}%\n`;
          }
        }
      }
      
      // Â∞áË®òÂ∏≥Êú¨ÂÖßÂÆπËàá user prompt ‰∏Ä‰ΩµÈÄÅÂá∫Ôºå‰∏¶Âä†‰∏äÂàÜÊûêÊåá‰ª§
      const totalExpense = expenses.reduce((sum, e) => sum + e.amount, 0);
      const balance = income - totalExpense;
      const expenseRatio = income > 0 ? (totalExpense / income * 100).toFixed(1) : 0;
      const fullPrompt = `‰ª•‰∏ãÊòØÊàëÁöÑË®òÂ∏≥Êú¨ÂÖßÂÆπÔºö\n${JSON.stringify(expenses, null, 2)}\n\nÊî∂ÊîØÁãÄÊ≥ÅÔºö\n- Êú¨ÊúàÊî∂ÂÖ•Ôºö$${income}\n- Á∏ΩÊîØÂá∫Ôºö$${totalExpense}\n- ÁµêÈ§òÔºö$${balance}\n- ÊîØÂá∫ÊØî‰æãÔºö${expenseRatio}%${historyAnalysis}\n\nË´ãÂÖàÂàÜÊûêÈÄô‰∫õÊîØÂá∫Á¥ÄÈåÑÊòØÂê¶Êúâ‰∏çÂêàÁêÜÁöÑË¶èÂäÉÔºåÁâπÂà•Ê≥®ÊÑèÊîØÂá∫ÊØî‰æãÊòØÂê¶ÈÅéÈ´ò„ÄÅÁµêÈ§òÊòØÂê¶Ë∂≥Â§†ÔºåËã•ÊúâË´ãÊåáÂá∫‰∏¶Ë©¢ÂïèÊàëÊòØÂê¶Ë¶ÅËß£ÈáãÈÄô‰∫õÊîØÂá∫ÔºåÁÑ∂ÂæåÊ†πÊìöÊàëÁöÑÊî∂ÊîØÁãÄÊ≥ÅÊèêÂá∫ÂÖ∑È´îÁêÜË≤°Âª∫Ë≠∞„ÄÇ\n\nË´ãÁâπÂà•ÈóúÊ≥®ÊàëÊòØÂê¶ÊØî‰πãÂâçÁöÑÂª∫Ë≠∞ÊúâÊâÄÈÄ≤Ê≠•ÔºåÂ¶ÇÊûúÊúâÈÄ≤Ê≠•Ë´ãÁµ¶‰∫àËÇØÂÆöÔºåÂ¶ÇÊûúÊ≤íÊúâÈÄ≤Ê≠•ÊàñÈÄÄÊ≠•Ë´ãÊåáÂá∫ÂïèÈ°å‰∏¶ÊèêÂá∫Êõ¥ÂÖ∑È´îÁöÑÊîπÂñÑÂª∫Ë≠∞„ÄÇ\n\nÊàëÁöÑÊèêÂïèÔºö${prompt}`;
      ws.send(JSON.stringify({ 
        prompt: fullPrompt, 
        system: `‰Ω†ÊòØ‰∏ÄÂÄãÊØíËàå‰ΩÜÁúüÂøÉÁÇ∫‰ΩøÁî®ËÄÖËëóÊÉ≥ÁöÑ AI ÁêÜË≤°Âä©ÁêÜÔºåÂ∞àÈñÄÂçîÂä©Ê™¢Ë¶ñÂÄã‰∫∫ÊîØÂá∫Á¥ÄÈåÑËàáÁêÜË≤°ÁøíÊÖ£„ÄÇ\n‰Ω†ÁöÑÈ¢®Ê†ºÁäÄÂà©Áõ¥Êé•ÔºåÂ∞çÊñºÁÑ°Ë¨ÇÊîØÂá∫ÔºàÂ¶ÇÈÅéÂ∫¶Â®õÊ®Ç„ÄÅÈ†ªÁπÅË≥ºÁâ©„ÄÅÈáçË§áÊ∂àË≤ªÁ≠âÔºâÊúÉÊèêÂá∫Âö¥Âé≤‰ΩÜÂØ¶Áî®ÁöÑÊâπË©ïËàáÊèêÈÜí„ÄÇ\nÂ¶ÇÊûú‰ΩøÁî®ËÄÖÈÄ£Á∫åÂÖ©ÈÄ±‰ª•‰∏äÊúâÈÄôÈ°ûÊîØÂá∫Ôºå‰Ω†ÊúÉ‰ª•Ë≤¨ÂÇôÁöÑË™ûÊ∞£ÊåáÂá∫ÂïèÈ°åÔºå‰∏¶ÊèêÂá∫ÂÖ∑È´îÊîπÂñÑÂª∫Ë≠∞„ÄÇ\nËã•ÊîØÂá∫ÂêàÁêÜÊàñÊîπÂñÑ‰∏≠Ôºå‰Ω†ÂèØ‰ª•Á®çÂæÆË™áÁçé‰∏¶ÈºìÂãµÊåÅÁ∫åÂä™Âäõ„ÄÇ\nË´ãÁâπÂà•ÈóúÊ≥®‰ΩøÁî®ËÄÖÁöÑÈÄ≤Ê≠•ÊÉÖÊ≥ÅÔºåÂ¶ÇÊûúÊúâÈÄ≤Ê≠•Ë¶ÅÁµ¶‰∫àËÇØÂÆöÔºåÂ¶ÇÊûúÊ≤íÊúâÈÄ≤Ê≠•Ë¶ÅÊåáÂá∫ÂïèÈ°å„ÄÇ\nË´ã‰ª•‰∏≠ÊñáÂõûÊáâÔºåË™ûÊ∞£ÂèØÁäÄÂà©‰ΩÜ‰∏çÊÉ°ÊØíÔºåÂÖßÂÆπÂãôÂØ¶‰∏îÂÖ∑Âª∫Ë®≠ÊÄß„ÄÇ`
      }));
      promptInput.value = '';
    };

    promptInput.addEventListener('keydown', e => {
      if (e.key === 'Enter') sendBtn.click();
    });

    // Ë®òÂ∏≥Ê≠∑Âè≤Á¥ÄÈåÑÂäüËÉΩ
    const expList = document.getElementById('expList');
    const expDate = document.getElementById('expDate');
    const expCategory = document.getElementById('expCategory');
    const expAmount = document.getElementById('expAmount');
    const expNote = document.getElementById('expNote');
    const addExpBtn = document.getElementById('addExpBtn');
    const expenses = [];

    function renderExpenses() {
      expList.innerHTML = '';
      expenses.forEach((e, index) => {
        const item = document.createElement('li');
        const week = calculateWeek(e.date);
        item.innerHTML = `${e.date}ÔΩú${e.category}ÔΩú$${e.amount}ÔΩú${e.note} <span class="week-indicator">Á¨¨${week}ÈÄ±</span> <button onclick="deleteExpense(${index})" style="margin-left:8px; padding:2px 6px; background:#ef4444; color:#fff; border:none; border-radius:3px; cursor:pointer; font-size:0.8em;">Âà™Èô§</button>`;
        expList.appendChild(item);
      });
      updateCharts();
    }

    // Âà™Èô§Ë®òÂ∏≥ÂäüËÉΩ
    function deleteExpense(index) {
      if (confirm('Á¢∫ÂÆöË¶ÅÂà™Èô§ÈÄôÁ≠ÜË®òÂ∏≥ÂóéÔºü')) {
        expenses.splice(index, 1);
        renderExpenses();
        // localStorage.setItem('expenses', JSON.stringify(expenses)); // Â∑≤ÁßªÈô§
      }
    }

    addExpBtn.onclick = () => {
      const date = expDate.value;
      const category = expCategory.value.trim();
      const amount = parseFloat(expAmount.value);
      const note = expNote.value.trim();
      if (!date || !category || isNaN(amount)) {
        alert('Ë´ãÂÆåÊï¥Â°´ÂØ´Êó•Êúü„ÄÅÈ°ûÂà•ËàáÈáëÈ°ç');
        return;
      }
      expenses.push({ date, category, amount, note });
      renderExpenses();
      expDate.value = '';
      expCategory.value = '';
      expAmount.value = '';
      expNote.value = '';
      // Âè™ÊúâÁ¥ØÁ©ç‰∏ÉÂÄã‰∏çÂêåÊó•ÊúüÊâçËá™ÂãïÂàÜÊûê
      const uniqueDates = Array.from(new Set(expenses.map(e => e.date)));
      if (uniqueDates.length === 7) {
        // Âú®ËÅäÂ§©ÂÆ§È°ØÁ§∫Ëá™ÂãïÂàÜÊûêÊèêÁ§∫
        chatDiv.innerHTML += `<div class="message user">ÔºàÁ≥ªÁµ±Ëá™ÂãïÂàÜÊûêÔºöÂ∑≤Á¥ØÁ©ç‰∏ÉÂÄã‰∏çÂêåÊó•ÊúüÁöÑË®òÂ∏≥Ôºâ</div>`;
        chatDiv.scrollTop = chatDiv.scrollHeight;
        const autoPrompt = 'Ë´ãÊ†πÊìöÁõÆÂâçÊâÄÊúâË®òÂ∏≥Á¥ÄÈåÑÔºåÂàÜÊûêÊòØÂê¶Êúâ‰∏çÂêàÁêÜÁöÑÊîØÂá∫ÊàñÁêÜË≤°ÂïèÈ°åÔºå‰∏¶‰∏ªÂãïÊèêÂá∫ÂÖ∑È´îÂª∫Ë≠∞„ÄÇ';
        // Ê∫ñÂÇôÊ≠∑Âè≤Âª∫Ë≠∞ÂàÜÊûê
        let historyAnalysis = '';
        if (adviceHistory.length > 0) {
          historyAnalysis = `\n\n=== Ê≠∑Âè≤Âª∫Ë≠∞ÂàÜÊûê ===\n`;
          adviceHistory.forEach((advice, index) => {
            const adviceDate = new Date(advice.timestamp).toLocaleDateString('zh-TW');
            const expenseCount = advice.expenses ? advice.expenses.length : 0;
            const totalExpenseAtTime = advice.expenses ? advice.expenses.reduce((sum, e) => sum + e.amount, 0) : 0;
            historyAnalysis += `\nÂª∫Ë≠∞ ${index + 1} (${adviceDate}):\n`;
            historyAnalysis += `Áï∂ÊôÇË®òÂ∏≥Á≠ÜÊï∏: ${expenseCount} Á≠Ü\n`;
            historyAnalysis += `Áï∂ÊôÇÁ∏ΩÊîØÂá∫: $${totalExpenseAtTime}\n`;
            historyAnalysis += `Âª∫Ë≠∞ÂÖßÂÆπ: ${advice.advice}\n`;
            historyAnalysis += `---\n`;
          });
          // ÂàÜÊûêÈÄ≤Ê≠•ÊÉÖÊ≥Å
          const currentTotalExpense = expenses.reduce((sum, e) => sum + e.amount, 0);
          const currentExpenseRatio = income > 0 ? (currentTotalExpense / income * 100).toFixed(1) : 0;
          if (adviceHistory.length > 1) {
            const previousAdvice = adviceHistory[adviceHistory.length - 2];
            const previousTotalExpense = previousAdvice.expenses ? previousAdvice.expenses.reduce((sum, e) => sum + e.amount, 0) : 0;
            const previousExpenseRatio = income > 0 ? (previousTotalExpense / income * 100).toFixed(1) : 0;
            historyAnalysis += `\n=== ÈÄ≤Ê≠•ÂàÜÊûê ===\n`;
            historyAnalysis += `‰∏äÊ¨°Á∏ΩÊîØÂá∫: $${previousTotalExpense} (ÊîØÂá∫ÊØî‰æã: ${previousExpenseRatio}%)\n`;
            historyAnalysis += `Êú¨Ê¨°Á∏ΩÊîØÂá∫: $${currentTotalExpense} (ÊîØÂá∫ÊØî‰æã: ${currentExpenseRatio}%)\n`;
            if (currentTotalExpense < previousTotalExpense) {
              historyAnalysis += `‚úÖ ÈÄ≤Ê≠•: ÊîØÂá∫Ê∏õÂ∞ë $${previousTotalExpense - currentTotalExpense}\n`;
            } else if (currentTotalExpense > previousTotalExpense) {
              historyAnalysis += `‚ö†Ô∏è ÈúÄÊ≥®ÊÑè: ÊîØÂá∫Â¢ûÂä† $${currentTotalExpense - previousTotalExpense}\n`;
            } else {
              historyAnalysis += `‚û°Ô∏è ÊåÅÂπ≥: ÊîØÂá∫Á∂≠ÊåÅÁõ∏Âêå\n`;
            }
            if (currentExpenseRatio < previousExpenseRatio) {
              historyAnalysis += `‚úÖ ÈÄ≤Ê≠•: ÊîØÂá∫ÊØî‰æã‰∏ãÈôç ${previousExpenseRatio - currentExpenseRatio}%\n`;
            } else if (currentExpenseRatio > previousExpenseRatio) {
              historyAnalysis += `‚ö†Ô∏è ÈúÄÊ≥®ÊÑè: ÊîØÂá∫ÊØî‰æã‰∏äÂçá ${currentExpenseRatio - previousExpenseRatio}%\n`;
            }
          }
        }
        const totalExpense = expenses.reduce((sum, e) => sum + e.amount, 0);
        const balance = income - totalExpense;
        const expenseRatio = income > 0 ? (totalExpense / income * 100).toFixed(1) : 0;
        const fullPrompt = `‰ª•‰∏ãÊòØÊàëÁöÑË®òÂ∏≥Êú¨ÂÖßÂÆπÔºö\n${JSON.stringify(expenses, null, 2)}\n\nÊî∂ÊîØÁãÄÊ≥ÅÔºö\n- Êú¨ÊúàÊî∂ÂÖ•Ôºö$${income}\n- Á∏ΩÊîØÂá∫Ôºö$${totalExpense}\n- ÁµêÈ§òÔºö$${balance}\n- ÊîØÂá∫ÊØî‰æãÔºö${expenseRatio}%${historyAnalysis}\n\nË´ãÂÖàÂàÜÊûêÈÄô‰∫õÊîØÂá∫Á¥ÄÈåÑÊòØÂê¶Êúâ‰∏çÂêàÁêÜÁöÑË¶èÂäÉÔºåÁâπÂà•Ê≥®ÊÑèÊîØÂá∫ÊØî‰æãÊòØÂê¶ÈÅéÈ´ò„ÄÅÁµêÈ§òÊòØÂê¶Ë∂≥Â§†ÔºåËã•ÊúâË´ãÊåáÂá∫‰∏¶Ë©¢ÂïèÊàëÊòØÂê¶Ë¶ÅËß£ÈáãÈÄô‰∫õÊîØÂá∫ÔºåÁÑ∂ÂæåÊ†πÊìöÊàëÁöÑÊî∂ÊîØÁãÄÊ≥ÅÊèêÂá∫ÂÖ∑È´îÁêÜË≤°Âª∫Ë≠∞„ÄÇ\n\nË´ãÁâπÂà•ÈóúÊ≥®ÊàëÊòØÂê¶ÊØî‰πãÂâçÁöÑÂª∫Ë≠∞ÊúâÊâÄÈÄ≤Ê≠•ÔºåÂ¶ÇÊûúÊúâÈÄ≤Ê≠•Ë´ãÁµ¶‰∫àËÇØÂÆöÔºåÂ¶ÇÊûúÊ≤íÊúâÈÄ≤Ê≠•ÊàñÈÄÄÊ≠•Ë´ãÊåáÂá∫ÂïèÈ°å‰∏¶ÊèêÂá∫Êõ¥ÂÖ∑È´îÁöÑÊîπÂñÑÂª∫Ë≠∞„ÄÇ\n\nÊàëÁöÑÊèêÂïèÔºö${autoPrompt}`;
        ws.send(JSON.stringify({
          prompt: fullPrompt,
          system: `‰Ω†ÊòØ‰∏ÄÂÄãÊØíËàå‰ΩÜÁúüÂøÉÁÇ∫‰ΩøÁî®ËÄÖËëóÊÉ≥ÁöÑ AI ÁêÜË≤°Âä©ÁêÜÔºåÂ∞àÈñÄÂçîÂä©Ê™¢Ë¶ñÂÄã‰∫∫ÊîØÂá∫Á¥ÄÈåÑËàáÁêÜË≤°ÁøíÊÖ£„ÄÇ\n‰Ω†ÁöÑÈ¢®Ê†ºÁäÄÂà©Áõ¥Êé•ÔºåÂ∞çÊñºÁÑ°Ë¨ÇÊîØÂá∫ÔºàÂ¶ÇÈÅéÂ∫¶Â®õÊ®Ç„ÄÅÈ†ªÁπÅË≥ºÁâ©„ÄÅÈáçË§áÊ∂àË≤ªÁ≠âÔºâÊúÉÊèêÂá∫Âö¥Âé≤‰ΩÜÂØ¶Áî®ÁöÑÊâπË©ïËàáÊèêÈÜí„ÄÇ\nÂ¶ÇÊûú‰ΩøÁî®ËÄÖÈÄ£Á∫åÂÖ©ÈÄ±‰ª•‰∏äÊúâÈÄôÈ°ûÊîØÂá∫Ôºå‰Ω†ÊúÉ‰ª•Ë≤¨ÂÇôÁöÑË™ûÊ∞£ÊåáÂá∫ÂïèÈ°åÔºå‰∏¶ÊèêÂá∫ÂÖ∑È´îÊîπÂñÑÂª∫Ë≠∞„ÄÇ\nËã•ÊîØÂá∫ÂêàÁêÜÊàñÊîπÂñÑ‰∏≠Ôºå‰Ω†ÂèØ‰ª•Á®çÂæÆË™áÁçé‰∏¶ÈºìÂãµÊåÅÁ∫åÂä™Âäõ„ÄÇ\nË´ãÁâπÂà•ÈóúÊ≥®‰ΩøÁî®ËÄÖÁöÑÈÄ≤Ê≠•ÊÉÖÊ≥ÅÔºåÂ¶ÇÊûúÊúâÈÄ≤Ê≠•Ë¶ÅÁµ¶‰∫àËÇØÂÆöÔºåÂ¶ÇÊûúÊ≤íÊúâÈÄ≤Ê≠•Ë¶ÅÊåáÂá∫ÂïèÈ°å„ÄÇ\nË´ã‰ª•‰∏≠ÊñáÂõûÊáâÔºåË™ûÊ∞£ÂèØÁäÄÂà©‰ΩÜ‰∏çÊÉ°ÊØíÔºåÂÖßÂÆπÂãôÂØ¶‰∏îÂÖ∑Âª∫Ë®≠ÊÄß„ÄÇ`
        }));
      }
    };

    document.getElementById('exportAdviceBtn').onclick = () => {
      if (adviceHistory.length === 0) {
        alert('Ê≤íÊúâÂª∫Ë≠∞Ë≥áÊñôÂèØ‰ª•ÂåØÂá∫');
        return;
      }
      const adviceData = {
        exportDate: new Date().toISOString(),
        adviceHistory: adviceHistory,
        currentExpenses: expenses
      };
      const blob = new Blob([JSON.stringify(adviceData, null, 2)], { type: 'application/json' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `ÁêÜË≤°Âª∫Ë≠∞_${new Date().toISOString().split('T')[0]}.json`;
      link.click();
    };

    document.getElementById('importAdviceBtn').onclick = () => {
      document.getElementById('importAdviceFile').click();
    };

    document.getElementById('importAdviceFile').onchange = (event) => {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const adviceData = JSON.parse(e.target.result);
          if (adviceData.adviceHistory && Array.isArray(adviceData.adviceHistory)) {
            adviceHistory = [...adviceHistory, ...adviceData.adviceHistory];
            const uniqueAdvice = [];
            const seenAdvice = new Set();
            adviceHistory.forEach(item => {
              if (!seenAdvice.has(item.advice)) {
                seenAdvice.add(item.advice);
                uniqueAdvice.push(item);
              }
            });
            adviceHistory = uniqueAdvice;
            localStorage.setItem('adviceHistory', JSON.stringify(adviceHistory));
            if (adviceHistory.length > 0) {
              const latestAdvice = adviceHistory[adviceHistory.length - 1];
              chatDiv.innerHTML += `<div class="message ai">AIÁêÜË≤°Âä©ÁêÜÔºö${latestAdvice.advice}</div>`;
              currentAdvice = latestAdvice.advice;
            }
            alert(`ÊàêÂäüÂåØÂÖ• ${adviceData.adviceHistory.length} Á≠ÜÂª∫Ë≠∞Ë≥áÊñô`);
          } else {
            alert('JSON Ê™îÊ°àÊ†ºÂºè‰∏çÊ≠£Á¢∫');
          }
        } catch (error) {
          alert('ËÆÄÂèñ JSON Ê™îÊ°àÂ§±Êïó: ' + error.message);
        }
      };
      reader.readAsText(file);
    };

    // È†ÅÈù¢ËºâÂÖ•ÊôÇÂòóË©¶ËÆÄÂèñÊú¨Âú∞ÂÑ≤Â≠òÁöÑË®òÂ∏≥Ë≥áÊñôÂíåÂª∫Ë≠∞
    window.onload = () => {
      // ËÆÄÂèñÂª∫Ë≠∞Ê≠∑Âè≤
      const savedAdvice = localStorage.getItem('adviceHistory');
      if (savedAdvice) {
        try {
          adviceHistory = JSON.parse(savedAdvice);
          if (adviceHistory.length > 0) {
            // È°ØÁ§∫ÊúÄÊñ∞ÁöÑÂª∫Ë≠∞
            const latestAdvice = adviceHistory[adviceHistory.length - 1];
            chatDiv.innerHTML += `<div class="message ai">AIÁêÜË≤°Âä©ÁêÜÔºö${latestAdvice.advice}</div>`;
            currentAdvice = latestAdvice.advice;
          }
        } catch (e) {
          console.error('ËÆÄÂèñÂª∫Ë≠∞Ê≠∑Âè≤Â§±Êïó:', e);
        }
      }
      // ‰∏ÄÂë®Êú™Ë®òÂ∏≥ÊèêÈÜí
      if (expenses.length > 0) {
        const lastDate = expenses.map(e => e.date).sort().reverse()[0];
        const last = new Date(lastDate);
        const now = new Date();
        const diffDays = Math.floor((now - last) / (1000 * 60 * 60 * 24));
        if (diffDays >= 7) {
          setTimeout(() => {
            alert('ÊÇ®Â∑≤Á∂ìË∂ÖÈÅé‰∏ÄÈÄ±Ê≤íÊúâË®òÂ∏≥ÂõâÔºåË®òÂæó‰øùÊåÅÁêÜË≤°ÁøíÊÖ£ÔºÅ');
          }, 500);
        }
      }
    };

    // ÊØèÊ¨°Êñ∞Â¢ûË®òÂ∏≥ÊôÇËá™ÂãïÂÑ≤Â≠òÂà∞Êú¨Âú∞
    // Â∑≤ÁßªÈô§

    // È†ÅÈù¢Èõ¢ÈñãÊèêÈÜíÂäüËÉΩ
    window.addEventListener('beforeunload', (event) => {
      // ÂÉÖÊèêÈÜíÂª∫Ë≠∞ÂåØÂá∫
      const message = 'Ê≥®ÊÑèÔºöÁõ¥Êé•ÈóúÈñâÁ∂≤È†ÅÂèØËÉΩÊúÉÈÅ∫Â§±Êú™ÂåØÂá∫ÁöÑÂª∫Ë≠∞Ë≥áÊñô„ÄÇÂª∫Ë≠∞ÂÖàÂåØÂá∫Âª∫Ë≠∞Ê™îÊ°àÂÜçÈõ¢Èñã„ÄÇ';
      event.preventDefault();
      event.returnValue = message;
      return message;
    });

    // Áï∂Áî®Êà∂ÂòóË©¶Èõ¢ÈñãÈ†ÅÈù¢ÊôÇÔºàÂ¶ÇÊåâ F5 ÈáçÊñ∞Êï¥ÁêÜ„ÄÅÈªûÊìäÈÄ£ÁµêÁ≠âÔºâ
    window.addEventListener('unload', () => {
      // ÂÉÖÂÑ≤Â≠òÂª∫Ë≠∞Ê≠∑Âè≤
      localStorage.setItem('adviceHistory', JSON.stringify(adviceHistory));
    });

    // Êî∂ÊîØË®àÁÆóÂô®ÂäüËÉΩ
    const incomeInput = document.getElementById('incomeInput');
    const totalExpenseSpan = document.getElementById('totalExpense');
    const balanceSpan = document.getElementById('balance');
    // ÂÑ≤Â≠òÊî∂ÂÖ•
    let income = Number(localStorage.getItem('income') || 0);
    incomeInput.value = income;

    function updateCalculator() {
      const totalExpense = expenses.reduce((sum, e) => sum + e.amount, 0);
      totalExpenseSpan.textContent = `$${totalExpense}`;
      balanceSpan.textContent = `$${income - totalExpense}`;
    }

    incomeInput.addEventListener('input', () => {
      income = Number(incomeInput.value) || 0;
      localStorage.setItem('income', income);
      updateCalculator();
    });

    // Âú® renderExpenses ÂèäÈ†ÅÈù¢ËºâÂÖ•ÊôÇÈÉΩË¶ÅÊõ¥Êñ∞
    const originalRenderExpenses = renderExpenses;
    renderExpenses = function() {
      originalRenderExpenses();
      updateCalculator();
    };
    window.addEventListener('DOMContentLoaded', updateCalculator);
  </script>
</body>
</html> 