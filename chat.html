<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI 聊天室</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f7f7f7; }
    #chat { white-space: pre-wrap; border: 1px solid #ccc; background: #fff; padding: 10px; max-height: 350px; overflow-y: auto; margin-bottom: 10px; border-radius: 6px; }
    .message.user { color: #0063b1; margin-bottom: 5px; text-align: right; }
    .message.ai { color: #333; margin-bottom: 5px; text-align: left; }
    #prompt { width: 70%; padding: 8px; border-radius: 4px; border: 1px solid #bbb; }
    #sendBtn { padding: 8px 16px; border-radius: 4px; border: none; background: #0063b1; color: #fff; cursor: pointer; }
    #sendBtn:disabled { background: #aaa; }
  </style>
</head>
<body>
  <h1>AI 聊天室</h1>
  <div id="chat"></div>
  <input id="prompt" type="text" placeholder="輸入訊息..." />
  <button id="sendBtn">送出</button>
  <hr style="margin:24px 0;">
  <h2>記帳歷史紀錄</h2>
  <div style="margin-bottom:8px;">
    <input type="date" id="expDate" />
    <input type="text" id="expCategory" placeholder="支出類別" />
    <input type="number" id="expAmount" placeholder="金額" style="width:80px;" />
    <input type="text" id="expNote" placeholder="備註" />
    <button id="addExpBtn">新增</button>
  </div>
  <ul id="expList" style="background:#fff; border:1px solid #ccc; border-radius:6px; padding:10px; min-height:40px;"></ul>
  <div style="margin-top:10px;">
    <button id="exportBtn" style="margin-right:10px; padding:6px 12px; background:#28a745; color:#fff; border:none; border-radius:4px; cursor:pointer;">匯出 CSV</button>
    <input type="file" id="importFile" accept=".csv" style="display:none;" />
    <button id="importBtn" style="padding:6px 12px; background:#17a2b8; color:#fff; border:none; border-radius:4px; cursor:pointer;">匯入 CSV</button>
    <button id="exportAdviceBtn" style="margin-left:10px; padding:6px 12px; background:#ffc107; color:#000; border:none; border-radius:4px; cursor:pointer;">匯出建議</button>
    <input type="file" id="importAdviceFile" accept=".json" style="display:none;" />
    <button id="importAdviceBtn" style="margin-left:10px; padding:6px 12px; background:#6f42c1; color:#fff; border:none; border-radius:4px; cursor:pointer;">匯入建議</button>
  </div>
  <script>
    const ws = new WebSocket(`wss://hshgpt.webduino.tw`);
    const chatDiv = document.getElementById('chat');
    const promptInput = document.getElementById('prompt');
    const sendBtn = document.getElementById('sendBtn');

    // 建議管理
    let adviceHistory = [];
    let currentAdvice = '';

    ws.onopen = () => console.log('WebSocket 已連線');
    ws.onerror = err => console.error('WebSocket 錯誤', err);
    ws.onclose = () => console.log('WebSocket 已斷線');

    ws.onmessage = event => {
      const data = JSON.parse(event.data);
      if (data.type === 'start') {
        // 顯示 AI 回應容器並禁用輸入
        chatDiv.innerHTML += '<div class="message ai"></div>';
        promptInput.disabled = true;
        sendBtn.disabled = true;
      } else if (data.type === 'chunk') {
        // 更新最後一則 AI 回應，前面加上 AI理財助理：前綴（僅第一次 chunk 時加）
        const msgs = chatDiv.querySelectorAll('.message.ai');
        if (msgs.length > 0) {
          if (msgs[msgs.length - 1].textContent === '') {
            msgs[msgs.length - 1].textContent = 'AI理財助理：';
          }
          // 過濾掉系統訊息
          const filteredDelta = data.delta
            .replace(/正在傳送 prompt 到 Azure OpenAI \(.*?\)\.\.\./g, '')
            .replace(/Azure OpenAI 回應:/g, '')
            .replace(/--- 回應結束 ---/g, '');
          if (filteredDelta.trim() !== '') {
            msgs[msgs.length - 1].textContent += filteredDelta;
            chatDiv.scrollTop = chatDiv.scrollHeight;
          }
        }
      } else if (data.type === 'end') {
        // 回應結束，恢復輸入並儲存建議
        promptInput.disabled = false;
        sendBtn.disabled = false;
        promptInput.focus();
        
        // 儲存新的建議
        const lastMsg = chatDiv.querySelectorAll('.message.ai');
        if (lastMsg.length > 0) {
          const newAdvice = lastMsg[lastMsg.length - 1].textContent.replace('AI理財助理：', '').trim();
          if (newAdvice && newAdvice !== currentAdvice) {
            // 結合舊建議並更新
            const adviceEntry = {
              timestamp: new Date().toISOString(),
              advice: newAdvice,
              expenses: [...expenses] // 複製當時的記帳資料
            };
            
            // 移除舊的相同建議（如果存在）
            adviceHistory = adviceHistory.filter(item => item.advice !== currentAdvice);
            
            // 加入新建議
            adviceHistory.push(adviceEntry);
            currentAdvice = newAdvice;
            
            // 儲存到 localStorage
            localStorage.setItem('adviceHistory', JSON.stringify(adviceHistory));
          }
        }
      } else if (data.type === 'error') {
        alert('錯誤: ' + data.message);
      }
    };

    sendBtn.onclick = () => {
      const prompt = promptInput.value.trim();
      if (!prompt) return;
      // 顯示使用者訊息
      chatDiv.innerHTML += `<div class="message user">${prompt}</div>`;
      chatDiv.scrollTop = chatDiv.scrollHeight;
      // 將記帳本內容與 user prompt 一併送出，並加上分析指令
      const fullPrompt = `以下是我的記帳本內容：\n${JSON.stringify(expenses, null, 2)}\n請先分析這些支出紀錄是否有不合理的規劃，若有請指出並詢問我是否要解釋這些支出，然後根據我的狀況提出具體理財建議。\n\n我的提問：${prompt}`;
      ws.send(JSON.stringify({ 
        prompt: fullPrompt, 
        system: `你是一個毒舌但真心為使用者著想的 AI 理財助理，專門協助檢視個人支出紀錄與理財習慣。\n你的風格犀利直接，對於無謂支出（如過度娛樂、頻繁購物、重複消費等）會提出嚴厲但實用的批評與提醒。\n如果使用者連續兩週以上有這類支出，你會以責備的語氣指出問題，並提出具體改善建議。\n若支出合理或改善中，你可以稍微誇獎並鼓勵持續努力。\n請以中文回應，語氣可犀利但不惡毒，內容務實且具建設性。`
      }));
      promptInput.value = '';
    };

    promptInput.addEventListener('keydown', e => {
      if (e.key === 'Enter') sendBtn.click();
    });

    // 記帳歷史紀錄功能
    const expList = document.getElementById('expList');
    const expDate = document.getElementById('expDate');
    const expCategory = document.getElementById('expCategory');
    const expAmount = document.getElementById('expAmount');
    const expNote = document.getElementById('expNote');
    const addExpBtn = document.getElementById('addExpBtn');
    const expenses = [];

    function renderExpenses() {
      expList.innerHTML = '';
      expenses.forEach(e => {
        const item = document.createElement('li');
        item.textContent = `${e.date}｜${e.category}｜$${e.amount}｜${e.note}`;
        expList.appendChild(item);
      });
    }

    addExpBtn.onclick = () => {
      const date = expDate.value;
      const category = expCategory.value.trim();
      const amount = parseFloat(expAmount.value);
      const note = expNote.value.trim();
      if (!date || !category || isNaN(amount)) {
        alert('請完整填寫日期、類別與金額');
        return;
      }
      expenses.push({ date, category, amount, note });
      renderExpenses();
      expDate.value = '';
      expCategory.value = '';
      expAmount.value = '';
      expNote.value = '';
      // 每新增三筆自動觸發 AI 分析
      if (expenses.length % 3 === 0) {
        // 在聊天室顯示自動分析提示
        chatDiv.innerHTML += `<div class="message user">（系統自動分析：已新增三筆記帳）</div>`;
        chatDiv.scrollTop = chatDiv.scrollHeight;
        const autoPrompt = '請根據目前所有記帳紀錄，分析是否有不合理的支出或理財問題，並主動提出具體建議。';
        const fullPrompt = `以下是我的記帳本內容：\n${JSON.stringify(expenses, null, 2)}\n請先分析這些支出紀錄是否有不合理的規劃，若有請指出並詢問我是否要解釋這些支出，然後根據我的狀況提出具體理財建議。\n\n我的提問：${autoPrompt}`;
        ws.send(JSON.stringify({
          prompt: fullPrompt,
          system: `你是一個毒舌但真心為使用者著想的 AI 理財助理，專門協助檢視個人支出紀錄與理財習慣。\n你的風格犀利直接，對於無謂支出（如過度娛樂、頻繁購物、重複消費等）會提出嚴厲但實用的批評與提醒。\n如果使用者連續兩週以上有這類支出，你會以責備的語氣指出問題，並提出具體改善建議。\n若支出合理或改善中，你可以稍微誇獎並鼓勵持續努力。\n請以中文回應，語氣可犀利但不惡毒，內容務實且具建設性。`
        }));
      }
    };

    // CSV 匯出功能
    // 移除自動匯出功能與自動下載
    // 恢復手動匯出/匯入功能
    document.getElementById('exportBtn').onclick = () => {
      if (expenses.length === 0) {
        alert('沒有記帳資料可以匯出');
        return;
      }
      const csvContent = '日期,類別,金額,備註\n' + 
        expenses.map(e => `${e.date},${e.category},${e.amount},${e.note}`).join('\n');
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `記帳記錄_${new Date().toISOString().split('T')[0]}.csv`;
      link.click();
    };

    document.getElementById('importBtn').onclick = () => {
      document.getElementById('importFile').click();
    };

    document.getElementById('importFile').onchange = (event) => {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        const csv = e.target.result;
        const lines = csv.split('\n');
        const newExpenses = [];
        for (let i = 1; i < lines.length; i++) {
          const line = lines[i].trim();
          if (line) {
            const [date, category, amount, note] = line.split(',');
            if (date && category && amount) {
              newExpenses.push({
                date: date.trim(),
                category: category.trim(),
                amount: parseFloat(amount),
                note: note ? note.trim() : ''
              });
            }
          }
        }
        if (newExpenses.length > 0) {
          expenses.length = 0;
          expenses.push(...newExpenses);
          renderExpenses();
          alert(`成功匯入 ${newExpenses.length} 筆記帳資料`);
        } else {
          alert('CSV 檔案格式不正確或沒有資料');
        }
      };
      reader.readAsText(file);
    };

    document.getElementById('exportAdviceBtn').onclick = () => {
      if (adviceHistory.length === 0) {
        alert('沒有建議資料可以匯出');
        return;
      }
      const adviceData = {
        exportDate: new Date().toISOString(),
        adviceHistory: adviceHistory,
        currentExpenses: expenses
      };
      const blob = new Blob([JSON.stringify(adviceData, null, 2)], { type: 'application/json' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `理財建議_${new Date().toISOString().split('T')[0]}.json`;
      link.click();
    };

    document.getElementById('importAdviceBtn').onclick = () => {
      document.getElementById('importAdviceFile').click();
    };

    document.getElementById('importAdviceFile').onchange = (event) => {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const adviceData = JSON.parse(e.target.result);
          if (adviceData.adviceHistory && Array.isArray(adviceData.adviceHistory)) {
            adviceHistory = [...adviceHistory, ...adviceData.adviceHistory];
            const uniqueAdvice = [];
            const seenAdvice = new Set();
            adviceHistory.forEach(item => {
              if (!seenAdvice.has(item.advice)) {
                seenAdvice.add(item.advice);
                uniqueAdvice.push(item);
              }
            });
            adviceHistory = uniqueAdvice;
            localStorage.setItem('adviceHistory', JSON.stringify(adviceHistory));
            if (adviceHistory.length > 0) {
              const latestAdvice = adviceHistory[adviceHistory.length - 1];
              chatDiv.innerHTML += `<div class="message ai">AI理財助理：${latestAdvice.advice}</div>`;
              currentAdvice = latestAdvice.advice;
            }
            alert(`成功匯入 ${adviceData.adviceHistory.length} 筆建議資料`);
          } else {
            alert('JSON 檔案格式不正確');
          }
        } catch (error) {
          alert('讀取 JSON 檔案失敗: ' + error.message);
        }
      };
      reader.readAsText(file);
    };

    // 頁面載入時嘗試讀取本地儲存的記帳資料和建議
    window.onload = () => {
      // 讀取記帳資料
      const savedExpenses = localStorage.getItem('expenses');
      if (savedExpenses) {
        try {
          const parsed = JSON.parse(savedExpenses);
          expenses.push(...parsed);
          renderExpenses();
        } catch (e) {
          console.error('讀取本地記帳資料失敗:', e);
        }
      }
      
      // 讀取建議歷史
      const savedAdvice = localStorage.getItem('adviceHistory');
      if (savedAdvice) {
        try {
          adviceHistory = JSON.parse(savedAdvice);
          if (adviceHistory.length > 0) {
            // 顯示最新的建議
            const latestAdvice = adviceHistory[adviceHistory.length - 1];
            chatDiv.innerHTML += `<div class="message ai">AI理財助理：${latestAdvice.advice}</div>`;
            currentAdvice = latestAdvice.advice;
          }
        } catch (e) {
          console.error('讀取建議歷史失敗:', e);
        }
      }
      
      // 自動匯出資料到檔案（每5分鐘）
      // setInterval(() => {
      //   autoExportData();
      // }, 5 * 60 * 1000);
    };

    // 自動匯出資料功能
    function autoExportData() {
      try {
        // 匯出記帳資料
        if (expenses.length > 0) {
          const csvContent = '日期,類別,金額,備註\n' + 
            expenses.map(e => `${e.date},${e.category},${e.amount},${e.note}`).join('\n');
          const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
          const link = document.createElement('a');
          link.href = URL.createObjectURL(blob);
          link.download = `記帳記錄_${new Date().toISOString().split('T')[0]}.csv`;
          link.click();
        }
        
        // 匯出建議資料
        if (adviceHistory.length > 0) {
          const adviceData = {
            exportDate: new Date().toISOString(),
            adviceHistory: adviceHistory,
            currentExpenses: expenses
          };
          const blob = new Blob([JSON.stringify(adviceData, null, 2)], { type: 'application/json' });
          const link = document.createElement('a');
          link.href = URL.createObjectURL(blob);
          link.download = `理財建議_${new Date().toISOString().split('T')[0]}.json`;
          link.click();
        }
        
        console.log('資料已自動匯出');
      } catch (error) {
        console.error('自動匯出失敗:', error);
      }
    }

    // 每次新增記帳時自動儲存到本地
    const originalAddExpBtn = addExpBtn.onclick;
    addExpBtn.onclick = () => {
      originalAddExpBtn();
      localStorage.setItem('expenses', JSON.stringify(expenses));
    };

    // 頁面離開提醒功能
    window.addEventListener('beforeunload', (event) => {
      // 檢查是否有未儲存的資料（這裡假設所有資料都會自動儲存到 localStorage）
      // 但為了安全起見，還是提醒用戶
      const message = '注意：直接關閉網頁可能會遺失未匯出的資料。建議先匯出 CSV 和建議檔案再離開。';
      event.preventDefault();
      event.returnValue = message;
      return message;
    });

    // 當用戶嘗試離開頁面時（如按 F5 重新整理、點擊連結等）
    window.addEventListener('unload', () => {
      // 確保資料已儲存到 localStorage
      localStorage.setItem('expenses', JSON.stringify(expenses));
      localStorage.setItem('adviceHistory', JSON.stringify(adviceHistory));
    });

    // 匯出建議功能
    // document.getElementById('exportAdviceBtn').onclick = () => {
    //   if (adviceHistory.length === 0) {
    //     alert('沒有建議資料可以匯出');
    //     return;
    //   }
    //   const adviceData = {
    //     exportDate: new Date().toISOString(),
    //     adviceHistory: adviceHistory,
    //     currentExpenses: expenses
    //   };
    //   const blob = new Blob([JSON.stringify(adviceData, null, 2)], { type: 'application/json' });
    //   const link = document.createElement('a');
    //   link.href = URL.createObjectURL(blob);
    //   link.download = `理財建議_${new Date().toISOString().split('T')[0]}.json`;
    //   link.click();
    // };

    // 匯入建議功能
    // document.getElementById('importAdviceBtn').onclick = () => {
    //   document.getElementById('importAdviceFile').click();
    // };

    // document.getElementById('importAdviceFile').onchange = (event) => {
    //   const file = event.target.files[0];
    //   if (!file) return;

    //   const reader = new FileReader();
    //   reader.onload = (e) => {
    //     try {
    //       const adviceData = JSON.parse(e.target.result);
    //       if (adviceData.adviceHistory && Array.isArray(adviceData.adviceHistory)) {
    //         // 合併建議歷史
    //         adviceHistory = [...adviceHistory, ...adviceData.adviceHistory];
            
    //         // 移除重複建議（基於建議內容）
    //         const uniqueAdvice = [];
    //         const seenAdvice = new Set();
    //         adviceHistory.forEach(item => {
    //           if (!seenAdvice.has(item.advice)) {
    //             seenAdvice.add(item.advice);
    //             uniqueAdvice.push(item);
    //           }
    //         });
    //         adviceHistory = uniqueAdvice;
            
    //         // 儲存到 localStorage
    //         localStorage.setItem('adviceHistory', JSON.stringify(adviceHistory));
            
    //         // 顯示最新建議
    //         if (adviceHistory.length > 0) {
    //           const latestAdvice = adviceHistory[adviceHistory.length - 1];
    //           chatDiv.innerHTML += `<div class="message ai">AI理財助理：${latestAdvice.advice}</div>`;
    //           currentAdvice = latestAdvice.advice;
    //         }
            
    //         alert(`成功匯入 ${adviceData.adviceHistory.length} 筆建議資料`);
    //       } else {
    //         alert('JSON 檔案格式不正確');
    //       }
    //     } catch (error) {
    //       alert('讀取 JSON 檔案失敗: ' + error.message);
    //     }
    //   };
    //   reader.readAsText(file);
    // };
  </script>
</body>
</html> 